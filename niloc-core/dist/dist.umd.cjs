(function(i,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(i=typeof globalThis<"u"?globalThis:i||self,h(i.dist={}))})(this,function(i){"use strict";var b=Object.defineProperty;var A=(i,h,d)=>h in i?b(i,h,{enumerable:!0,configurable:!0,writable:!0,value:d}):i[h]=d;var u=(i,h,d)=>(A(i,typeof h!="symbol"?h+"":h,d),d);i.Address=void 0,(r=>{const e={type:0};function t(){return e}r.broadcast=t;function s(o){return{type:1,id:o}}r.to=s;function n(o,a){return o.type===0||a.type===0?!0:o.id===a.id}r.match=n;function c(o){switch(o.type){case 0:return"*";case 1:return`:${o.id}`;default:return"?"}}r.toString=c;function _(o){return o==="*"?t():o.startsWith(":")?s(o.slice(1)):null}r.parse=_})(i.Address||(i.Address={}));var h=Object.defineProperty,d=(r,e,t)=>e in r?h(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,m=(r,e,t)=>(d(r,typeof e!="symbol"?e+"":e,t),t);class p{constructor(){m(this,"_listeners",{}),m(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}class f{constructor(e,t){u(this,"_address");u(this,"_emitter");u(this,"_id");this.network=t,this._id=e,this._address=i.Address.to(e),this._emitter=new p,t.emitter().on("message",({peerId:s,channel:n,message:c})=>this._onMessage(s,n,c))}emitter(){return this._emitter}send(e,t,s){const n={originId:this._id,address:e,data:s};for(const c of this.network.peers())i.Address.match(e,c.address())&&c.send(t,n)}id(){return this._id}_onMessage(e,t,s){i.Address.match(s.address,this._address)&&this._emitter.emit("message",{message:s,channel:t});for(const n of this.network.peers())n.id()!==e&&i.Address.match(s.address,n.address())&&n.send(t,s)}}let R=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function v(r){try{const e=r();return Promise.resolve(e)}catch(e){return Promise.reject(e)}}var l;(r=>{function e(n,c,_){return{type:0,id:n,name:c,data:_}}r.request=e;function t(n,c){return{type:1,id:n,data:c}}r.response=t;function s(n,c){return{type:2,id:n,reason:c}}r.error=s})(l||(l={}));class E{constructor(){u(this,"_emitter",new p);u(this,"_handlers",{});u(this,"_resultEmitter",new p)}emitter(){return this._emitter}handle(e,t){if(this._handlers[e]){console.error(`Cannot handle the same RPC multiple times (${e})`);return}this._handlers[e]=t}request(e,t,s){const n=R(),c=l.request(n,e,s);return new Promise((_,o)=>{let a=setTimeout(()=>{a=null,this._resultEmitter.emit(n,{type:2,data:"Timed out"})},2e4);this._resultEmitter.once(n,({type:w,data:y})=>{a&&clearTimeout(a),w===2?o(y):w===1&&_(y)}),this._emitter.emit("message",{targetId:t,message:c})})}post(e){const t=e.data,s=e.originId;switch(t.type){case 0:{this._onRequest(t,s);break}case 1:{this._onResponse(t);break}case 2:{this._onError(t);break}}}_onRequest(e,t){const{id:s,name:n,data:c}=e,_=this._handlers[n];if(!_){console.error(`Received unhandled RPC request '${n}', originated from ${t}`);const o=l.error(s,`Unhandled RPC by the receiver ${n}`);this._emitter.emit("message",{targetId:t,message:o});return}v(()=>_({data:c,originId:t})).then(o=>{const a=l.response(s,o);this._emitter.emit("message",{targetId:t,message:a})}).catch(o=>{console.error(`Error while handling RPC '${n}':`,o);const a=l.error(s,"Receiver got an error while responding");this._emitter.emit("message",{targetId:t,message:a})})}_onResponse(e){const{id:t,data:s}=e;this._resultEmitter.emit(t,{type:1,data:s})}_onError(e){const{id:t,reason:s}=e;this._resultEmitter.emit(t,{type:2,data:s})}}class C{constructor(){u(this,"_inputListener",null);u(this,"_outputListeners",new Set)}postOutput(...e){for(const t of this._outputListeners)t(...e)}addOutputListener(e){this._outputListeners.add(e)}removeOutputListener(e){this._outputListeners.delete(e)}postInput(...e){var t;(t=this._inputListener)==null||t.call(this,...e)}setInputListener(e){this._inputListener=e}}class S{constructor(e){u(this,"_channel");u(this,"_mpsc",new C);u(this,"_input");u(this,"_output");this._channel=e,this._input={post:(t,s)=>this._mpsc.postInput(t,s),addListener:t=>this._mpsc.addOutputListener(t),removeListener:t=>this._mpsc.removeOutputListener(t)},this._output={post:t=>this._mpsc.postOutput(t),setListener:t=>this._mpsc.setInputListener(t)}}channel(){return this._channel}input(){return this._input}output(){return this._output}}var L=(r=>(r[r.Data=0]="Data",r[r.RPC=1]="RPC",r))(L||{});const P=Object.keys(L).length/2,g=r=>r+P;class O{constructor(e,t){u(this,"_rpc");u(this,"_emitter",new p);u(this,"_channels",{});u(this,"router");this.id=e,this.network=t,this.router=new f(e,t),this.router.emitter().on("message",({message:s,channel:n})=>this._onMessage(s,n)),this._rpc=new E,this._rpc.emitter().on("message",({targetId:s,message:n})=>{this.router.send(i.Address.to(s),1,n)})}rpc(){return this._rpc}emitter(){return this._emitter}send(e,t){this.router.send(e,0,t)}channel(e){const t=g(e);return this._channels[t]||(this._channels[t]=this._createChannel(e)),this._channels[t].input()}_createChannel(e){const t=new S(e);return t.output().setListener((s,n)=>{this.router.send(s,g(e),n)}),t}_onMessage(e,t){if(t===0){this._emitter.emit("message",e);return}if(t===1){this._rpc.post(e);return}this._channels[t]&&this._channels[t].output().post(e)}}i.Application=O,i.Router=f,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
