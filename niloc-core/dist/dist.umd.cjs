(function(n,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(n=typeof globalThis<"u"?globalThis:n||self,a(n.dist={}))})(this,function(n){"use strict";var A=Object.defineProperty;var b=(n,a,l)=>a in n?A(n,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[a]=l;var d=(n,a,l)=>(b(n,typeof a!="symbol"?a+"":a,l),l);n.Address=void 0,(i=>{const e={type:0};function t(){return e}i.broadcast=t;function r(o){return{type:1,id:o}}i.to=r;function s(o,h){return o.type===0||h.type===0?!0:o.id===h.id}i.match=s;function c(o){switch(o.type){case 0:return"*";case 1:return`:${o.id}`;default:return"?"}}i.toString=c;function u(o){return o==="*"?t():o.startsWith(":")?r(o.slice(1)):null}i.parse=u})(n.Address||(n.Address={}));var a=Object.defineProperty,l=(i,e,t)=>e in i?a(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,f=(i,e,t)=>(l(i,typeof e!="symbol"?e+"":e,t),t);class m{constructor(){f(this,"_listeners",{}),f(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const r of[...this._listeners[e]])r(t);if(this._onceListeners[e]){for(const r of[...this._onceListeners[e]])r(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}class p{constructor(e,t){d(this,"_address");d(this,"_emitter");d(this,"_id");this.network=t,this._id=e,this._address=n.Address.to(e),this._emitter=new m,t.emitter().on("message",({peerId:r,channel:s,message:c})=>this._onMessage(r,s,c))}emitter(){return this._emitter}send(e,t,r){const s={originId:this._id,address:e,data:r};for(const c of this.network.peers())n.Address.match(e,c.address())&&c.send(t,s)}id(){return this._id}_onMessage(e,t,r){n.Address.match(r.address,this._address)&&this._emitter.emit("message",{message:r,channel:t});for(const s of this.network.peers())s.id()!==e&&n.Address.match(r.address,s.address())&&s.send(t,r)}}let y=(i=21)=>crypto.getRandomValues(new Uint8Array(i)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function R(i){try{const e=i();return Promise.resolve(e)}catch(e){return Promise.reject(e)}}var _;(i=>{function e(s,c,u){return{type:0,id:s,name:c,data:u}}i.request=e;function t(s,c){return{type:1,id:s,data:c}}i.response=t;function r(s,c){return{type:2,id:s,reason:c}}i.error=r})(_||(_={}));class L{constructor(){d(this,"_emitter",new m);d(this,"_handlers",{});d(this,"_resultEmitter",new m)}emitter(){return this._emitter}handle(e,t){if(this._handlers[e]){console.error(`Cannot handle the same RPC multiple times (${e})`);return}this._handlers[e]=t}request(e,t,r){const s=y(),c=_.request(s,e,r);return new Promise((u,o)=>{let h=setTimeout(()=>{h=null,this._resultEmitter.emit(s,{type:2,data:"Timed out"})},2e4);this._resultEmitter.once(s,({type:g,data:w})=>{h&&clearTimeout(h),g===2?o(w):g===1&&u(w)}),this._emitter.emit("message",{targetId:t,message:c})})}post(e){const t=e.data,r=e.originId;switch(t.type){case 0:{this._onRequest(t,r);break}case 1:{this._onResponse(t);break}case 2:{this._onError(t);break}}}_onRequest(e,t){const{id:r,name:s,data:c}=e,u=this._handlers[s];if(!u){console.error(`Received unhandled RPC request '${s}', originated from ${t}`);const o=_.error(r,`Unhandled RPC by the receiver ${s}`);this._emitter.emit("message",{targetId:t,message:o});return}R(()=>u({data:c,originId:t})).then(o=>{const h=_.response(r,o);this._emitter.emit("message",{targetId:t,message:h})}).catch(o=>{console.error(`Error while handling RPC '${s}':`,o);const h=_.error(r,"Receiver got an error while responding");this._emitter.emit("message",{targetId:t,message:h})})}_onResponse(e){const{id:t,data:r}=e;this._resultEmitter.emit(t,{type:1,data:r})}_onError(e){const{id:t,reason:r}=e;this._resultEmitter.emit(t,{type:2,data:r})}}class v{constructor(e,t){d(this,"_rpc");d(this,"_emitter",new m);d(this,"router");this.id=e,this.network=t,this.router=new p(e,t),this.router.emitter().on("message",({message:r,channel:s})=>this._onMessage(r,s)),this._rpc=new L,this._rpc.emitter().on("message",({targetId:r,message:s})=>{this.router.send(n.Address.to(r),1,s)})}rpc(){return this._rpc}emitter(){return this._emitter}send(e,t){this.router.send(e,0,t)}_onMessage(e,t){if(t===0){this._emitter.emit("message",e);return}if(t===1){this._rpc.post(e);return}}}n.Application=v,n.Router=p,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
