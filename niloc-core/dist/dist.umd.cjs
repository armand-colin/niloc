(function(h,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(h=typeof globalThis<"u"?globalThis:h||self,d(h.dist={}))})(this,function(h){"use strict";var ae=Object.defineProperty;var le=(h,d,b)=>d in h?ae(h,d,{enumerable:!0,configurable:!0,writable:!0,value:b}):h[d]=b;var i=(h,d,b)=>(le(h,typeof d!="symbol"?d+"":d,b),b);h.Address=void 0,(c=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function n(){return e}c.all=n;function r(){return t}c.broadcast=r;function o(){return s}c.host=o;function a(l){return{type:2,id:l}}c.to=a;function u(l){return{type:4,get:l}}c.dynamic=u;function g(l,y,p){return p.address().type===1||p.address().type===0||y.type===0?!0:y.type===1?p.id()!==l:y.type===3?p.address().type===3:(y.type===4?y.get():y.id)===p.id()}c.match=g;function he(l){switch(l.type){case 0:return"*";case 1:return"#";case 2:return`:${l.id}`;case 4:return`:${l.get()}`;case 3:return"host";default:return"?"}}c.toString=he;function oe(l){return l==="*"?n():l==="#"?r():l==="host"?o():l.startsWith(":")?a(l.slice(1)):null}c.parse=oe})(h.Address||(h.Address={}));class d{constructor(){i(this,"_inputListener",null);i(this,"_outputListeners",new Set)}postOutput(...e){for(const t of this._outputListeners)t(...e)}addOutputListener(e){this._outputListeners.add(e)}removeOutputListener(e){this._outputListeners.delete(e)}postInput(...e){var t;(t=this._inputListener)==null||t.call(this,...e)}setInputListener(e){this._inputListener=e}}class b{constructor(e){i(this,"_channel");i(this,"_mpsc",new d);i(this,"_input");i(this,"_output");this._channel=e,this._input={post:(t,s)=>this._mpsc.postInput(t,s),addListener:t=>this._mpsc.addOutputListener(t),removeListener:t=>this._mpsc.removeOutputListener(t)},this._output={post:t=>this._mpsc.postOutput(t),setListener:t=>this._mpsc.setInputListener(t)}}channel(){return this._channel}input(){return this._input}output(){return this._output}}class I{constructor(e,t){i(this,"host");i(this,"userId");this.host=t,this.userId=e}}class P{constructor(e){i(this,"_id");i(this,"_relay");i(this,"_address");i(this,"_self");i(this,"_context");i(this,"_channels",{});i(this,"network");this._id=e.id,this._relay=e.relay??!1,this._address=e.host?h.Address.host():h.Address.to(e.id),this._context=new I(e.id,e.host??!1),this._self={id:()=>this._id,address:()=>this._address,send:(t,s)=>{this._onMessage(this._id,t,s)}},this.network=e.network,this.network.emitter().on("message",({peerId:t,channel:s,message:n})=>this._onMessage(t,s,n))}id(){return this._id}address(){return this._address}self(){return this._self}channel(e){return this._channels[e]||(this._channels[e]=this._createChannel(e)),this._channels[e].input()}context(){return this._context}_onMessage(e,t,s){if(h.Address.match(e,s.address,this._self)&&this._receive(t,s),!!this._relay)for(const n of this.network.peers())n.id()!==e&&h.Address.match(e,s.address,n)&&n.send(t,s)}_receive(e,t){this._channels[e]&&this._channels[e].output().post(t)}_createChannel(e){const t=new b(e);return t.output().setListener((s,n)=>{this._send(s,e,n)}),t}_send(e,t,s){const n={originId:this._id,address:e,data:s};for(const r of this.network.peers())h.Address.match(this._id,e,r)&&r.send(t,n);h.Address.match(this._id,e,this._self)&&this._receive(t,n)}}var J=Object.defineProperty,N=(c,e,t)=>e in c?J(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,v=(c,e,t)=>(N(c,typeof e!="symbol"?e+"":e,t),t);class m{constructor(){v(this,"_listeners",{}),v(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}h.Channel=void 0,(c=>{function e(t,s){const n=[],r=new m;t.addListener(o=>{const[a,u]=o.data;r.emit(a.toString(),{...o,data:u})});for(let o=0;o<s;o++)n.push({post:(a,u)=>{t.post(a,[o,u])},addListener:a=>{r.on(o.toString(),a)},removeListener:a=>{r.off(o.toString(),a)}});return n}c.split=e})(h.Channel||(h.Channel={})),h.Authority=(c=>(c[c.All=0]="All",c[c.Host=1]="Host",c[c.Owner=2]="Owner",c))(h.Authority||{}),(c=>{function e(t,s){switch(t.authority){case 0:return!0;case 1:return s.host;case 2:return s.userId===t.id()}return!1}c.allows=e})(h.Authority||(h.Authority={}));class L{constructor(){i(this,"_string","")}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class R{constructor(){i(this,"_indent",0);i(this,"_string","");i(this,"_line",new L)}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new L}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class _{constructor(){i(this,"_index",-1);i(this,"_changeRequester",null);i(this,"_emitter",new m)}static setIndex(e,t){e._index=t}static setChangeRequester(e,t){e._changeRequester=t,e.onChangeRequester(t)}static setModelHandle(e,t){e.onModelHandle(t)}static toString(e){const t=new R;return this.write(e,t),t.toString()}static write(e,t){e.toString(t)}static register(e,t){const s=[...e];for(const n of s)n.emitter().on("changed",t);return()=>{for(const n of s)n.emitter().off("changed",t)}}index(){return this._index}emitter(){return this._emitter}readChange(e){this.read(e)}writeChange(e){this.write(e)}clearChange(){}changed(){var e;(e=this._changeRequester)==null||e.change(this._index),this._emitter.emit("changed")}onChangeRequester(e){}onModelHandle(e){}toString(e){e.writeLine("???")}}class k extends _{constructor(t){super();i(this,"value");this.value=t}get(){return this.value}set(t){this.value=t,this.changed()}read(t){this.readValue(t),this.emitter().emit("changed")}write(t){t.writeJSON(this.value)}toString(t){switch(typeof this.value){case"function":t.writeLine("[Function]");break;case"object":t.write(JSON.stringify(this.value));break;default:t.writeLine(""+this.value);break}}}class $ extends k{readValue(e){this.value=e.readBoolean()}writeValue(e){e.writeBoolean(this.value)}}class w{constructor(e){i(this,"_id");i(this,"_fields",null);i(this,"_changeRequester");i(this,"authority",h.Authority.All);i(this,"deleted",new $(!1));i(this,"_onDeletedChanged",()=>{this.deleted.get()&&(this._changeRequester.delete(),this.deleted.emitter().on("changed",this._onDeletedChanged.bind(this)))});this._id=e,this.deleted.emitter().on("changed",this._onDeletedChanged.bind(this))}static __setChangeRequester(e,t){e._changeRequester=t;for(const s of e.fields())_.setChangeRequester(s,t)}static __setModelHandle(e,t){for(const s of e.fields())_.setModelHandle(s,t)}static toString(e){const t=new R;return this.write(e,t),t.toString()}static write(e,t){t.writeLine(`${e.constructor.name}: ${e.id()} {`),t.startIndent();for(const s of e.fields())_.write(s,t);t.endIndent(),t.writeLine("}")}id(){return this._id}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())t.read(e)}write(e){for(const t of this.fields())t.write(e)}send(){this._changeRequester.send()}register(e){return _.register(this.fields(),e)}delete(){this.deleted.get()||(this.deleted.set(!0),this._changeRequester.send(),this._changeRequester.delete())}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof _&&(_.setIndex(s,e.length),e.push(s))}return e}}let E=(c=21)=>crypto.getRandomValues(new Uint8Array(c)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");var C;(c=>{function e(t){return{emitter(){return t.emitter},context(){return t.context},syncTo:t.syncTo,get:t.get,requestObject(n,r){return t.objectsEmitter.on(n,r),r(t.get(n)),{destroy(){t.objectsEmitter.off(n,r)}}}}}c.make=e})(C||(C={}));class D{constructor(){i(this,"_changes",new Map);i(this,"_syncs",new Set)}change(e,t){if(this._syncs.has(e))return;let s=this._changes.get(e);s||(s=[],this._changes.set(e,s)),!s.includes(t)&&s.push(t)}sync(e){this._syncs.add(e),this._changes.delete(e)}*changes(){const e={objectId:"",fields:[]};for(const[t,s]of this._changes)e.objectId=t,e.fields=s,yield e;this._changes.clear()}*syncs(){for(const e of this._syncs)yield e;this._syncs.clear()}changeForObject(e){const t=this._changes.get(e);return this._changes.delete(e),t??null}}class z{constructor(){i(this,"_buffer",[]);i(this,"_cursor",0)}feed(e){this._buffer=e,this._cursor=0}cursor(){return this._cursor}setCursor(e){this._cursor=e}skip(e){this._cursor+=e}empty(){return this._cursor>=this._buffer.length}readJSON(){const e=this._buffer[this._cursor];this._cursor++;try{return JSON.parse(e)}catch(t){return console.error("Failed to parse JSON",t),null}}readString(){return this._buffer[this._cursor++]}readFloat(){return parseFloat(this._buffer[this._cursor++])}readInt(){return parseInt(this._buffer[this._cursor++],36)}readBoolean(){return this._buffer[this._cursor++]==="1"}}class Q{constructor(){i(this,"_buffer",[]);i(this,"_cursor",-1)}collect(){const e=this._buffer;return this._buffer=[],e}cursor(){return this._cursor===-1?this._buffer.length:this._cursor}setCursor(e){e===this._buffer.length&&(e=-1),this._cursor=e}resume(){this.setCursor(-1)}_write(e){this._cursor===-1?this._buffer.push(e):this._buffer[this._cursor++]=e}writeJSON(e){this._write(JSON.stringify(e))}writeString(e){this._write(e)}writeInt(e){this._write(e.toString(36))}writeFloat(e){this._write(e.toString())}writeBoolean(e){this._write(e?"1":"0")}}class B{constructor(){i(this,"_templates",new Map);i(this,"_reverseTemplates",new Map)}register(e,t){t=t??e.constructor.name,this._templates.set(t,e),this._reverseTemplates.set(e,t)}getTypeId(e){return this._reverseTemplates.get(e.constructor)??null}getType(e){return this._templates.get(e)??null}}class A{constructor(e){i(this,"_channel");i(this,"_context");i(this,"_emitter",new m);i(this,"_objectsEmitter",new m);i(this,"_templates",new B);i(this,"_objects",new Map);i(this,"_handle");i(this,"_changeQueue",new D);i(this,"_reader",new z);i(this,"_writer",new Q);i(this,"_plugins",[]);i(this,"_onMessage",e=>{switch(e.data.type){case"sync":{this._onSync(e.data.changes);break}case"change":{this._onChange(e.data.changes);break}}});this._channel=e.channel,this._channel.addListener(this._onMessage),this._context=e.context,this._handle=C.make({emitter:this._emitter,objectsEmitter:this._objectsEmitter,context:this._context,syncTo:t=>this.syncTo(t),get:t=>this.get(t)})}emitter(){return this._emitter}plugin(e){var t;this._plugins.push(e),(t=e.init)==null||t.call(e,this._handle)}register(e,t){this._templates.register(e,t)}instantiate(e,t){const s=t??E(),n=this._create(e,s);return this._changeQueue.sync(s),n}send(){const e=this._collectSyncs(),t=this._collectChanges();e.length>0&&this._channel.post(h.Address.broadcast(),{type:"sync",changes:e}),t.length>0&&this._channel.post(h.Address.broadcast(),{type:"change",changes:t})}sendObject(e){const t=this._collectSyncsForObjects([e]),s=this._changeQueue.changeForObject(e),n=s?this._collectChangesForObjects([{objectId:e,fields:s}]):[];t.length>0&&this._channel.post(h.Address.broadcast(),{type:"sync",changes:t}),n.length>0&&this._channel.post(h.Address.broadcast(),{type:"change",changes:n})}syncTo(e){const t=this._collectGlobalSyncs();t.length>0&&this._channel.post(e,{type:"sync",changes:t})}get(e){return this._objects.get(e)??null}getAll(){return[...this._objects.values()]}_create(e,t){var n;const s=new e(t);w.__setChangeRequester(s,this._makeChangeRequester(t)),w.__setModelHandle(s,this._handle),this._objects.set(t,s);for(const r of this._plugins)(n=r.beforeCreate)==null||n.call(r,s);return this._emitter.emit("created",s),this._objectsEmitter.emit(t,s),s}_makeChangeRequester(e){return{change:t=>this._onChangeRequest(e,t),send:()=>this.sendObject(e),delete:()=>this._delete(e)}}_onChangeRequest(e,t){this._changeQueue.change(e,t)}_collectGlobalSyncs(){return this._collectSyncsForObjects(this._objects.keys())}_collectSyncs(){return this._collectSyncsForObjects(this._changeQueue.syncs())}_collectSyncsForObjects(e){const t=this._writer;for(const s of e){const n=this._objects.get(s);if(!n)continue;const r=this._templates.getTypeId(n);r!==null&&h.Authority.allows(n,this._context)&&(t.writeString(n.id()),t.writeString(r),n.write(t))}return t.collect()}_collectChanges(){return this._collectChangesForObjects(this._changeQueue.changes())}_collectChangesForObjects(e){const t=this._writer;for(const{objectId:s,fields:n}of e){const r=this._objects.get(s);if(!r||!h.Authority.allows(r,this._context))continue;t.writeString(s),t.writeInt(n.length);const o=t.cursor();t.writeInt(0);for(const u of n){const g=r.fields()[u];t.writeInt(u),g.writeChange(t),g.clearChange()}const a=t.cursor();t.setCursor(o),t.writeInt(a-o-1),t.resume()}return t.collect()}_delete(e){this._objects.has(e)&&(this._objects.delete(e),this._emitter.emit("deleted",e),this._objectsEmitter.emit(e,null))}_onSync(e){const t=this._reader;for(t.feed(e);!t.empty();){const s=t.readString(),n=t.readString();let r=this._objects.get(s);if(r){r.read(t);continue}const o=this._templates.getType(n);if(!o){console.error("Could not create object with type",n);return}r=this._create(o,s),r.read(t)}}_onChange(e){const t=this._reader;for(t.feed(e);!t.empty();){const s=t.readString(),n=t.readInt(),r=t.readInt(),o=this._objects.get(s);if(!o){t.skip(r);continue}for(let a=0;a<n;a++){const u=t.readInt();o.fields()[u].readChange(t)}}}}class F extends k{readValue(e){this.value=e.readJSON()}writeValue(e){e.writeJSON(this.value)}}class V{constructor(){i(this,"_changes",[])}get last(){return this._changes[this._changes.length-1]}*_reverse(){for(let e=this._changes.length-1;e>-1;e--)yield this._changes[e]}push(...e){const t=this.last;if(t&&t.type===0){t.values.push(...e);return}this._changes.push({type:0,values:e})}pop(){const e=this.last;if(e){if(e.type===0){this._changes.pop();return}if(e.type===1){e.n++;return}}this._changes.push({type:1,n:1})}set(e,t){for(const s of this._reverse()){if(s.type!==2)break;if(s.index===e){s.value=t;return}}this._changes.push({type:2,index:e,value:t})}clear(){this._changes=[],this._changes.push({type:3})}write(e){e.writeInt(this._changes.length);for(const t of this._changes)switch(e.writeInt(t.type),t.type){case 0:e.writeInt(t.values.length);for(const s of t.values)e.writeJSON(s);break;case 1:e.writeInt(t.n);break;case 2:e.writeInt(t.index),e.writeJSON(t.value);break}}read(e,t){const s=e.readInt();for(let n=0;n<s;n++)switch(e.readInt()){case 0:const o=e.readInt();for(let g=0;g<o;g++)t.push(e.readJSON());break;case 1:const a=e.readInt();for(let g=0;g<a;g++)t.pop();break;case 2:const u=e.readInt();t[u]=e.readJSON();break;case 3:t.splice(0,t.length);break}}reset(){this._changes=[]}}class U extends _{constructor(t){super();i(this,"_value");i(this,"_changes",new V);this._value=t}get(){return this._value}push(...t){this._value.push(...t),this._changes.push(...t),this.changed()}pop(){const t=this._value.pop();return t&&(this._changes.pop(),this.changed()),t??null}set(t){this._value=t,this._changes.clear(),this._changes.push(...t),this.changed()}setAt(t,s){if(t<0||t>=this._value.length)throw new Error("Index out of range");this._value[t]=s,this._changes.set(t,s),this.changed()}clear(){this._value.length!==0&&(this._value=[],this._changes.clear(),this.changed())}read(t){this._value=t.readJSON(),this.emitter().emit("changed")}write(t){t.writeJSON(this._value)}readChange(t){this._changes.read(t,this._value),this.changed()}writeChange(t){this._changes.write(t)}clearChange(){this._changes.reset()}}class H extends _{constructor(t,s){super();i(this,"_object");i(this,"_changes",[]);this._object=new t(s??"sub")}get(){return this._object}read(t){this._object.read(t),this.emitter().emit("changed")}write(t){this._object.write(t)}readChange(t){const s=t.readInt();for(let n=0;n<s;n++){const r=t.readInt();this._object.fields()[r].readChange(t)}this.emitter().emit("changed")}writeChange(t){const s=this._changes.length;t.writeInt(s);for(const n of this._changes)t.writeInt(n),this._object.fields()[n].writeChange(t)}clearChange(){for(const t of this._changes)this._object.fields()[t].clearChange();this._changes=[]}onModelHandle(t){w.__setModelHandle(this._object,t)}onChangeRequester(t){w.__setChangeRequester(this._object,{change:s=>{this._changes.push(s),t.change(this.index()),this.emitter().emit("changed")},send:()=>{t.send()},delete:()=>{console.error("SyncObjectField: delete is not supported, as it cannot be null for its parent object. This is an undefined behaviour.")}})}toString(t){w.write(this._object,t)}}class M extends _{constructor(t){super();i(this,"_objectId");i(this,"_object",null);i(this,"_modelHandle",null);i(this,"_objectRequest",null);this._objectId=t}read(t){const s=t.readJSON();s!==this._objectId&&(this._setObjectId(s),this.emitter().emit("changed"))}write(t){t.writeJSON(this._objectId)}set(t){const s=(t==null?void 0:t.id())??null;s!==this._objectId&&(this._setObjectId(s),this.changed())}get(){return this._object}_setObjectId(t){var s,n;(s=this._objectRequest)==null||s.destroy(),this._objectId=t,this._object=null,t?this._objectRequest=((n=this._modelHandle)==null?void 0:n.requestObject(t,r=>{this._object=r}))??null:this._objectRequest=null,this.emitter().emit("changed")}onModelHandle(t){this._modelHandle=t,this._objectId&&this._setObjectId(this._objectId)}toString(t){t.write("ref "),this._object?w.write(this._object,t):t.writeLine(`${this._objectId} (null)`)}}class W extends _{constructor(){super(...arguments);i(this,"_objects",new Map);i(this,"_modelHandle",null)}add(t){this._objects.set(t.id(),t),this.changed()}remove(t){this._objects.delete(t.id()),this.changed()}has(t){return this._objects.has(t.id())}*values(){for(const t of this._objects.values())t!==null&&(yield t)}read(t){var n;const s=t.readInt();this._objects.clear();for(let r=0;r<s;r++){const o=t.readString();this._objects.set(o,((n=this._modelHandle)==null?void 0:n.get(o))??null)}this.emitter().emit("changed")}write(t){t.writeInt(this._objects.size);for(const s of this._objects.keys())t.writeString(s)}onModelHandle(t){this._modelHandle=t,this._modelHandle.emitter().on("created",s=>{const n=s.id();this._objects.has(n)&&this._objects.set(n,s),this.emitter().emit("changed")})}}class q{constructor(e){i(this,"_model",null);i(this,"_onConnected",e=>{this._model&&this._model.syncTo(h.Address.to(e))});i(this,"_onSync",()=>{this._model&&this._model.syncTo(h.Address.broadcast())});e.emitter().on("connected",this._onConnected),e.emitter().on("sync",this._onSync)}init(e){this._model=e}}class G{beforeCreate(e){e.authority=h.Authority.Owner}}class X{constructor(e){i(this,"_connectionList");i(this,"_model");i(this,"_emitter",new m);i(this,"_user");i(this,"_others",[]);i(this,"_onUserCreated",e=>{this._connectionList.isConnected(e.id())&&!this._others.includes(e)&&(this._others.push(e),this._emitter.emit("changed",this.users()),this._emitter.emit("connected",e))});i(this,"_onConnected",e=>{if(e===this._user.id()||this._others.some(s=>s.id()===e))return;const t=this._model.get(e);t&&(this._others.push(t),this._emitter.emit("changed",this.users()),this._emitter.emit("connected",t))});i(this,"_onDisconnected",e=>{if(e===this._user.id())return;const t=this._others.findIndex(s=>s.id()===e);t<0||(this._others.splice(t,1),this._emitter.emit("changed",this.users()),this._emitter.emit("disconnected",e))});this._connectionList=e.connectionList,this._model=new A({channel:e.channel,context:e.context}),this._model.register(e.type,"user"),this._model.plugin(new q(e.connectionList)),this._model.plugin(new G),this._user=this._model.instantiate(e.type,e.context.userId),e.connectionList.emitter().on("connected",this._onConnected),e.connectionList.emitter().on("disconnected",this._onDisconnected),this._model.emitter().on("created",t=>this._onUserCreated(t));for(const t of this._connectionList.users())this._onConnected(t)}user(){return this._user}users(){return[this._user,...this._others]}others(){return[...this._others]}emitter(){return this._emitter}send(){this._model.send()}register(e){const t={};for(const r of[this._user,...this._others])t[r.id()]=r.register(e);function s(r){t[r.id()]=r.register(e)}function n(r){const o=t[r];o&&(o(),delete t[r])}return this.emitter().on("connected",s),this.emitter().on("disconnected",n),()=>{this.emitter().off("connected",s),this.emitter().off("disconnected",n);for(const r of Object.values(t))r()}}}class S{constructor(e,t){i(this,"_isOwner");i(this,"_channel");i(this,"_users",new Set);i(this,"_emitter",new m);i(this,"_onMessage",e=>{switch(e.data.type){case"connected":{if(this._isOwner||this._users.has(e.data.userId))return;this._connected(e.data.userId);break}case"disconnected":{if(this._isOwner||!this._users.has(e.data.userId))return;this._disconnected(e.data.userId);break}case"sync":{if(this._isOwner)return;this._sync(e.data.userIds)}}});this._isOwner=e,this._channel=t,this._channel.addListener(this._onMessage)}static owner(e){return new S(!0,e)}static client(e){return new S(!1,e)}emitter(){return this._emitter}users(){return this._users.values()}isConnected(e){return this._users.has(e)}connected(e){this._users.has(e)||(this._connected(e),this._isOwner&&(this._channel.post(h.Address.broadcast(),{type:"connected",userId:e}),this._channel.post(h.Address.to(e),{type:"sync",userIds:[...this._users]})))}disconnected(e){this._users.has(e)&&(this._disconnected(e),this._isOwner&&this._channel.post(h.Address.broadcast(),{type:"disconnected",userId:e}))}_connected(e){this._users.add(e),this._emitter.emit("connected",e)}_disconnected(e){this._users.delete(e),this._emitter.emit("disconnected",e)}_sync(e){for(const t of[...this._users])e.includes(t)||this._disconnected(t);for(const t of e)this._users.has(t)||this._connected(t);this._emitter.emit("sync")}}class f{constructor(e,t){i(this,"_callback");i(this,"_callHandler",null);i(this,"address");this._callback=t,this.address=e}static setCallHandler(e,t){e._callHandler=t}static host(e){return new f(h.Address.host(),e)}static target(e,t){return new f(h.Address.to(e),t)}static broadcast(e){return new f(h.Address.broadcast(),e)}static all(e){return new f(h.Address.all(),e)}static dynamic(e,t){return new f(h.Address.dynamic(e),t)}static call(e,t){try{e._callback(...t)}catch(s){console.error("Error while executing RPC:",s)}}call(...e){if(this._callHandler===null)throw new Error("Trying to call RPC without initialization");return this._callHandler.call(this.address,e)}}var O;(c=>{function e(t,s){return{id:t,args:s}}c.make=e})(O||(O={}));class T{constructor(e,t){i(this,"_self");i(this,"_channel");i(this,"_rpcs",{});i(this,"_onMessage",e=>{const t=e.data,s=e.originId;h.Address.match(e.originId,e.address,this._self)&&this._onRequest(t,s)});this._self=e,this._channel=t,this._channel.addListener(this._onMessage)}register(e,t){if(this._rpcs[t]){console.error("Trying to register rpc twice:",t);return}this._rpcs[t]=e,f.setCallHandler(e,this._makeCallHandler(t))}infuse(e,t){for(const s in e)e[s]instanceof f&&this.register(e[s],`${t}.${s}`)}_makeCallHandler(e){return{call:(s,n)=>{const r=O.make(e,n);this._channel.post(s,r)}}}_onRequest(e,t){const{id:s,args:n}=e,r=this._rpcs[s];if(!r){console.error(`Received unhandled RPC request '${s}', originated from ${t}`);return}f.call(r,n)}}class Y{constructor(e,t){i(this,"_handler");this._handler=new T(e,t)}beforeCreate(e){let t=0;for(const s in e){const n=e[s];n instanceof f&&this._handler.register(n,`${e.id()}.${t++}`)}}}function Z(c){return console.log("enter any",c),function(e,t){console.log("enter any f",e,t);const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(r){this[s].set(r)}}),Object.defineProperty(e,s,{get(){let r=this[n];return r||(r=new F(c),this[n]=r),r},enumerable:!0})}}function K(c){return function(e,t){const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()}}),Object.defineProperty(e,s,{get(){let r=this[n];return r||(r=new H(c),this[n]=r),r},enumerable:!0})}}function x(c){return function(e,t){const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(r){this[s].set(r)}}),Object.defineProperty(e,s,{get(){let r=this[n];return r||(r=new M(c),this[n]=r),r},enumerable:!0})}}const ee={any:Z,syncObject:K,syncObjectRef:x};function j(c){return function(e,t,s){const n="$"+t,r=Symbol(t),o=s.value;s.value=function(...a){this[n].call(...a)},Object.defineProperty(e,n,{get(){let a=this[r];return a||(a=new f(c(this),o.bind(this)),a.call=a.call.bind(a),this[r]=a),a},enumerable:!0})}}function te(){return j(h.Address.host)}function se(){return j(h.Address.all)}function ne(){return j(h.Address.broadcast)}function ie(){return j(c=>h.Address.to(c.id()))}function re(c){return j(()=>h.Address.dynamic(c))}const ce={host:te,all:se,broadcast:ne,owner:ie,dynamic:re};h.AnyField=F,h.ArrayField=U,h.ConnectionList=S,h.ConnectionPlugin=q,h.Context=I,h.Emitter=m,h.Field=_,h.Model=A,h.Presence=X,h.RPC=f,h.RPCHandler=T,h.RPCPlugin=Y,h.Router=P,h.SyncObject=w,h.SyncObjectField=H,h.SyncObjectRefField=M,h.SyncObjectRefSetField=W,h.field=ee,h.rpc=ce,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
