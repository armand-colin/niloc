(function(c,b){typeof exports=="object"&&typeof module<"u"?b(exports):typeof define=="function"&&define.amd?define(["exports"],b):(c=typeof globalThis<"u"?globalThis:c||self,b(c.dist={}))})(this,function(c){"use strict";c.Address=void 0,(r=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function n(){return e}r.all=n;function i(){return t}r.broadcast=i;function h(){return s}r.host=h;function o(a){return{type:2,id:a}}r.to=o;function l(a){return{type:4,get:a}}r.dynamic=l;function _(a,m,y){return y.address().type===1||y.address().type===0||m.type===0?!0:m.type===1?y.id()!==a:m.type===3?y.address().type===3:(m.type===4?m.get():m.id)===y.id()}r.match=_;function oe(a){switch(a.type){case 0:return"*";case 1:return"#";case 2:return`:${a.id}`;case 4:return`:${a.get()}`;case 3:return"host";default:return"?"}}r.toString=oe;function ae(a){return a==="*"?n():a==="#"?i():a==="host"?h():a.startsWith(":")?o(a.slice(1)):null}r.parse=ae})(c.Address||(c.Address={}));class b{constructor(){this._inputListener=null,this._outputListeners=new Set}postOutput(...e){for(const t of this._outputListeners)t(...e)}addOutputListener(e){this._outputListeners.add(e)}removeOutputListener(e){this._outputListeners.delete(e)}postInput(...e){var t;(t=this._inputListener)==null||t.call(this,...e)}setInputListener(e){this._inputListener=e}}class F{constructor(e){this._mpsc=new b,this._channel=e,this._input={post:(t,s)=>this._mpsc.postInput(t,s),addListener:t=>this._mpsc.addOutputListener(t),removeListener:t=>this._mpsc.removeOutputListener(t)},this._output={post:t=>this._mpsc.postOutput(t),setListener:t=>this._mpsc.setInputListener(t)}}channel(){return this._channel}input(){return this._input}output(){return this._output}}class C{constructor(e,t){this.host=t,this.userId=e}}class M{constructor(e){this._channels={},this._id=e.id,this._relay=e.relay??!1,this._address=e.host?c.Address.host():c.Address.to(e.id),this._context=new C(e.id,e.host??!1),this._self={id:()=>this._id,address:()=>this._address,send:(t,s)=>{this._onMessage(this._id,t,s)}},this.network=e.network,this.network.emitter().on("message",({peerId:t,channel:s,message:n})=>this._onMessage(t,s,n))}id(){return this._id}address(){return this._address}self(){return this._self}channel(e){return this._channels[e]||(this._channels[e]=this._createChannel(e)),this._channels[e].input()}context(){return this._context}_onMessage(e,t,s){if(c.Address.match(e,s.address,this._self)&&this._receive(t,s),!!this._relay)for(const n of this.network.peers())n.id()!==e&&c.Address.match(e,s.address,n)&&n.send(t,s)}_receive(e,t){this._channels[e]&&this._channels[e].output().post(t)}_createChannel(e){const t=new F(e);return t.output().setListener((s,n)=>{this._send(s,e,n)}),t}_send(e,t,s){const n={originId:this._id,address:e,data:s};for(const i of this.network.peers())c.Address.match(this._id,e,i)&&i.send(t,n);c.Address.match(this._id,e,this._self)&&this._receive(t,n)}}var P=Object.defineProperty,T=(r,e,t)=>e in r?P(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,O=(r,e,t)=>(T(r,typeof e!="symbol"?e+"":e,t),t);class f{constructor(){O(this,"_listeners",{}),O(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}c.Channel=void 0,(r=>{function e(t,s){const n=[],i=new f;t.addListener(h=>{const[o,l]=h.data;i.emit(o.toString(),{...h,data:l})});for(let h=0;h<s;h++)n.push({post:(o,l)=>{t.post(o,[h,l])},addListener:o=>{i.on(h.toString(),o)},removeListener:o=>{i.off(h.toString(),o)}});return n}r.split=e})(c.Channel||(c.Channel={})),c.Authority=(r=>(r[r.All=0]="All",r[r.Host=1]="Host",r[r.Owner=2]="Owner",r))(c.Authority||{}),(r=>{function e(t,s){switch(t.authority){case 0:return!0;case 1:return s.host;case 2:return s.userId===t.id()}return!1}r.allows=e})(c.Authority||(c.Authority={}));class v{constructor(){this._string=""}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class I{constructor(){this._indent=0,this._string="",this._line=new v}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new v}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class d{constructor(){this._index=-1,this._changeRequester=null,this._emitter=new f}static setIndex(e,t){e._index=t}static setChangeRequester(e,t){e._changeRequester=t,e.onChangeRequester(t)}static setModelHandle(e,t){e.onModelHandle(t)}static toString(e){const t=new I;return this.write(e,t),t.toString()}static write(e,t){e.toString(t)}static register(e,t){const s=[...e];for(const n of s)n.emitter().on("changed",t);return()=>{for(const n of s)n.emitter().off("changed",t)}}index(){return this._index}emitter(){return this._emitter}readChange(e){this.read(e)}writeChange(e){this.write(e)}clearChange(){}changed(){var e;(e=this._changeRequester)==null||e.change(this._index),this._emitter.emit("changed")}onChangeRequester(e){}onModelHandle(e){}toString(e){e.writeLine("???")}}class L extends d{constructor(e){super(),this.value=e}get(){return this.value}set(e){this.value=e,this.changed()}read(e){this.readValue(e),this.emitter().emit("changed")}write(e){e.writeJSON(this.value)}toString(e){switch(typeof this.value){case"function":e.writeLine("[Function]");break;case"object":e.write(JSON.stringify(this.value));break;default:e.writeLine(""+this.value);break}}}class J extends L{readValue(e){this.value=e.readBoolean()}writeValue(e){e.writeBoolean(this.value)}}class g{constructor(e){this._fields=null,this.authority=c.Authority.All,this.deleted=new J(!1),this._onDeletedChanged=()=>{this.deleted.get()&&(this._changeRequester.delete(),this.deleted.emitter().on("changed",this._onDeletedChanged.bind(this)))},this._id=e,this.deleted.emitter().on("changed",this._onDeletedChanged.bind(this))}static __setChangeRequester(e,t){e._changeRequester=t;for(const s of e.fields())d.setChangeRequester(s,t)}static __setModelHandle(e,t){for(const s of e.fields())d.setModelHandle(s,t)}static toString(e){const t=new I;return this.write(e,t),t.toString()}static write(e,t){t.writeLine(`${e.constructor.name}: ${e.id()} {`),t.startIndent();for(const s of e.fields())d.write(s,t);t.endIndent(),t.writeLine("}")}id(){return this._id}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())t.read(e)}write(e){for(const t of this.fields())t.write(e)}send(){this._changeRequester.send()}register(e){return d.register(this.fields(),e)}delete(){this.deleted.get()||(this.deleted.set(!0),this._changeRequester.send(),this._changeRequester.delete())}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof d&&(d.setIndex(s,e.length),e.push(s))}return e}}let N=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");var j;(r=>{function e(t){return{emitter(){return t.emitter},context(){return t.context},syncTo:t.syncTo,get:t.get,requestObject(n,i){return t.objectsEmitter.on(n,i),i(t.get(n)),{destroy(){t.objectsEmitter.off(n,i)}}},changeQueue(){return t.changeQueue},send:t.send}}r.make=e})(j||(j={}));class ${constructor(){this._changes=new Map,this._syncs=new Set,this._emitter=new f}emitter(){return this._emitter}needsSend(){return this._syncs.size>0||this._changes.size>0}change(e,t){if(this._syncs.has(e))return;let s=this._changes.size===0&&this._syncs.size===0,n=this._changes.get(e);n||(n=[],this._changes.set(e,n)),!n.includes(t)&&(n.push(t),s&&this._emitter.emit("needsSend"))}sync(e){const t=this._syncs.size===0&&this._changes.size===0;this._syncs.add(e),this._changes.delete(e),t&&this._emitter.emit("needsSend")}*changes(){const e={objectId:"",fields:[]};for(const[t,s]of this._changes)e.objectId=t,e.fields=s,yield e;this._changes.clear()}*syncs(){for(const e of this._syncs)yield e;this._syncs.clear()}changeForObject(e){const t=this._changes.get(e);return this._changes.delete(e),t??null}}class Q{constructor(){this._buffer=[],this._cursor=0}feed(e){this._buffer=e,this._cursor=0}cursor(){return this._cursor}setCursor(e){this._cursor=e}skip(e){this._cursor+=e}empty(){return this._cursor>=this._buffer.length}readJSON(){const e=this._buffer[this._cursor];this._cursor++;try{return JSON.parse(e)}catch(t){return console.error("Failed to parse JSON",t),null}}readString(){return this._buffer[this._cursor++]}readFloat(){return parseFloat(this._buffer[this._cursor++])}readInt(){return parseInt(this._buffer[this._cursor++],36)}readBoolean(){return this._buffer[this._cursor++]==="1"}}class z{constructor(){this._buffer=[],this._cursor=-1}collect(){const e=this._buffer;return this._buffer=[],e}cursor(){return this._cursor===-1?this._buffer.length:this._cursor}setCursor(e){e===this._buffer.length&&(e=-1),this._cursor=e}resume(){this.setCursor(-1)}_write(e){this._cursor===-1?this._buffer.push(e):this._buffer[this._cursor++]=e}writeJSON(e){this._write(JSON.stringify(e))}writeString(e){this._write(e)}writeInt(e){this._write(e.toString(36))}writeFloat(e){this._write(e.toString())}writeBoolean(e){this._write(e?"1":"0")}}class E{constructor(){this._templates=new Map,this._reverseTemplates=new Map}register(e,t){t=t??e.name,this._templates.set(t,e),this._reverseTemplates.set(e,t)}getTypeId(e){return this._reverseTemplates.get(e.constructor)??null}getType(e){return this._templates.get(e)??null}}class k{constructor(e){this._emitter=new f,this._objectsEmitter=new f,this._typesHandler=new E,this._objects=new Map,this._changeQueue=new $,this._reader=new Q,this._writer=new z,this._plugins=[],this._onMessage=t=>{switch(t.data.type){case"sync":{this._onSync(t.data.changes);break}case"change":{this._onChange(t.data.changes);break}}},this._channel=e.channel,this._channel.addListener(this._onMessage),this._context=e.context,this._handle=j.make({emitter:this._emitter,objectsEmitter:this._objectsEmitter,context:this._context,syncTo:t=>this.syncTo(t),get:t=>this.get(t),changeQueue:this._changeQueue,send:()=>this.send()})}emitter(){return this._emitter}plugin(e){this.addPlugin(e)}addPlugin(e){var t;return this._plugins.push(e),(t=e.init)==null||t.call(e,this._handle),this}register(e,t){this._typesHandler.register(e,t)}instantiate(e,t){const s=t??N(),n=this._create(e,s);return this._changeQueue.sync(s),n}send(e){let t,s;e!==void 0?(t=this._collectSyncsForObjects([e]),s=this._collectChangesForObjects([{objectId:e,fields:this._changeQueue.changeForObject(e)??[]}])):(t=this._collectSyncs(),s=this._collectChanges()),t.length>0&&this._channel.post(c.Address.broadcast(),{type:"sync",changes:t}),s.length>0&&this._channel.post(c.Address.broadcast(),{type:"change",changes:s})}syncTo(e){const t=this._collectGlobalSyncs();t.length>0&&this._channel.post(e,{type:"sync",changes:t})}get(e){return this._objects.get(e)??null}getAll(){return[...this._objects.values()]}_create(e,t){var n;const s=new e(t);g.__setChangeRequester(s,this._makeChangeRequester(t)),g.__setModelHandle(s,this._handle),this._objects.set(t,s);for(const i of this._plugins)(n=i.beforeCreate)==null||n.call(i,s);return this._emitter.emit("created",s),this._objectsEmitter.emit(t,s),s}_makeChangeRequester(e){return{change:t=>this._onChangeRequest(e,t),send:()=>this.send(e),delete:()=>this._delete(e)}}_onChangeRequest(e,t){this._changeQueue.change(e,t)}_collectGlobalSyncs(){return this._collectSyncsForObjects(this._objects.keys())}_collectSyncs(){return this._collectSyncsForObjects(this._changeQueue.syncs())}_collectSyncsForObjects(e){const t=this._writer;for(const s of e){const n=this._objects.get(s);if(!n)continue;const i=this._typesHandler.getTypeId(n);i!==null&&c.Authority.allows(n,this._context)&&(t.writeString(n.id()),t.writeString(i),n.write(t))}return t.collect()}_collectChanges(){return this._collectChangesForObjects(this._changeQueue.changes())}_collectChangesForObjects(e){const t=this._writer;for(const{objectId:s,fields:n}of e){const i=this._objects.get(s);if(!i||!c.Authority.allows(i,this._context))continue;t.writeString(s),t.writeInt(n.length);const h=t.cursor();t.writeInt(0);for(const l of n){const _=i.fields()[l];t.writeInt(l),_.writeChange(t),_.clearChange()}const o=t.cursor();t.setCursor(h),t.writeInt(o-h-1),t.resume()}return t.collect()}_delete(e){this._objects.has(e)&&(this._objects.delete(e),this._emitter.emit("deleted",e),this._objectsEmitter.emit(e,null))}_onSync(e){const t=this._reader;for(t.feed(e);!t.empty();){const s=t.readString(),n=t.readString();let i=this._objects.get(s);if(i){i.read(t);continue}const h=this._typesHandler.getType(n);if(!h){console.error("Could not create object with type",n);return}i=this._create(h,s),i.read(t)}}_onChange(e){const t=this._reader;for(t.feed(e);!t.empty();){const s=t.readString(),n=t.readInt(),i=t.readInt(),h=this._objects.get(s);if(!h){t.skip(i);continue}for(let o=0;o<n;o++){const l=t.readInt();h.fields()[l].readChange(t)}}}}class R extends L{readValue(e){this.value=e.readJSON()}writeValue(e){e.writeJSON(this.value)}}class D{constructor(){this._changes=[]}get last(){return this._changes[this._changes.length-1]}*_reverse(){for(let e=this._changes.length-1;e>-1;e--)yield this._changes[e]}push(...e){const t=this.last;if(t&&t.type===0){t.values.push(...e);return}this._changes.push({type:0,values:e})}pop(){const e=this.last;if(e){if(e.type===0){this._changes.pop();return}if(e.type===1){e.n++;return}}this._changes.push({type:1,n:1})}set(e,t){for(const s of this._reverse()){if(s.type!==2)break;if(s.index===e){s.value=t;return}}this._changes.push({type:2,index:e,value:t})}clear(){this._changes=[],this._changes.push({type:3})}write(e){e.writeInt(this._changes.length);for(const t of this._changes)switch(e.writeInt(t.type),t.type){case 0:e.writeInt(t.values.length);for(const s of t.values)e.writeJSON(s);break;case 1:e.writeInt(t.n);break;case 2:e.writeInt(t.index),e.writeJSON(t.value);break}}read(e,t){const s=e.readInt();for(let n=0;n<s;n++)switch(e.readInt()){case 0:const h=e.readInt();for(let _=0;_<h;_++)t.push(e.readJSON());break;case 1:const o=e.readInt();for(let _=0;_<o;_++)t.pop();break;case 2:const l=e.readInt();t[l]=e.readJSON();break;case 3:t.splice(0,t.length);break}}reset(){this._changes=[]}}class V extends d{constructor(e){super(),this._changes=new D,this._value=e}get(){return this._value}push(...e){this._value.push(...e),this._changes.push(...e),this.changed()}pop(){const e=this._value.pop();return e&&(this._changes.pop(),this.changed()),e??null}set(e){this._value=e,this._changes.clear(),this._changes.push(...e),this.changed()}setAt(e,t){if(e<0||e>=this._value.length)throw new Error("Index out of range");this._value[e]=t,this._changes.set(e,t),this.changed()}clear(){this._value.length!==0&&(this._value=[],this._changes.clear(),this.changed())}read(e){this._value=e.readJSON(),this.emitter().emit("changed")}write(e){e.writeJSON(this._value)}readChange(e){this._changes.read(e,this._value),this.changed()}writeChange(e){this._changes.write(e)}clearChange(){this._changes.reset()}}class H extends d{constructor(e,t){super(),this._changes=[],this._object=new e(t??"sub")}get(){return this._object}read(e){this._object.read(e),this.emitter().emit("changed")}write(e){this._object.write(e)}readChange(e){const t=e.readInt();for(let s=0;s<t;s++){const n=e.readInt();this._object.fields()[n].readChange(e)}this.emitter().emit("changed")}writeChange(e){const t=this._changes.length;e.writeInt(t);for(const s of this._changes)e.writeInt(s),this._object.fields()[s].writeChange(e)}clearChange(){for(const e of this._changes)this._object.fields()[e].clearChange();this._changes=[]}onModelHandle(e){g.__setModelHandle(this._object,e)}onChangeRequester(e){g.__setChangeRequester(this._object,{change:t=>{this._changes.push(t),e.change(this.index()),this.emitter().emit("changed")},send:()=>{e.send()},delete:()=>{console.error("SyncObjectField: delete is not supported, as it cannot be null for its parent object. This is an undefined behaviour.")}})}toString(e){g.write(this._object,e)}}class A extends d{constructor(e){super(),this._object=null,this._modelHandle=null,this._objectRequest=null,this._objectId=e}read(e){const t=e.readJSON();t!==this._objectId&&(this._setObjectId(t),this.emitter().emit("changed"))}write(e){e.writeJSON(this._objectId)}set(e){const t=(e==null?void 0:e.id())??null;t!==this._objectId&&(this._setObjectId(t),this.changed())}get(){return this._object}_setObjectId(e){var t,s;(t=this._objectRequest)==null||t.destroy(),this._objectId=e,this._object=null,e?this._objectRequest=((s=this._modelHandle)==null?void 0:s.requestObject(e,n=>{this._object=n}))??null:this._objectRequest=null,this.emitter().emit("changed")}onModelHandle(e){this._modelHandle=e,this._objectId&&this._setObjectId(this._objectId)}toString(e){e.write("ref "),this._object?g.write(this._object,e):e.writeLine(`${this._objectId} (null)`)}}class B extends d{constructor(){super(...arguments),this._objects=new Map,this._modelHandle=null}add(e){this._objects.set(e.id(),e),this.changed()}remove(e){this._objects.delete(e.id()),this.changed()}has(e){return this._objects.has(e.id())}*values(){for(const e of this._objects.values())e!==null&&(yield e)}read(e){var s;const t=e.readInt();this._objects.clear();for(let n=0;n<t;n++){const i=e.readString();this._objects.set(i,((s=this._modelHandle)==null?void 0:s.get(i))??null)}this.emitter().emit("changed")}write(e){e.writeInt(this._objects.size);for(const t of this._objects.keys())e.writeString(t)}onModelHandle(e){this._modelHandle=e,this._modelHandle.emitter().on("created",t=>{const s=t.id();this._objects.has(s)&&this._objects.set(s,t),this.emitter().emit("changed")})}}class q{constructor(e){this._model=null,this._onConnected=t=>{this._model&&this._model.syncTo(c.Address.to(t))},this._onSync=()=>{this._model&&this._model.syncTo(c.Address.broadcast())},e.emitter().on("connected",this._onConnected),e.emitter().on("sync",this._onSync)}init(e){this._model=e}}class U{beforeCreate(e){e.authority=c.Authority.Owner}}class W{constructor(e){this._emitter=new f,this._others=[],this._onUserCreated=t=>{this._connectionList.isConnected(t.id())&&!this._others.includes(t)&&(this._others.push(t),this._emitter.emit("changed",this.users()),this._emitter.emit("connected",t))},this._onConnected=t=>{if(t===this._user.id()||this._others.some(n=>n.id()===t))return;const s=this._model.get(t);s&&(this._others.push(s),this._emitter.emit("changed",this.users()),this._emitter.emit("connected",s))},this._onDisconnected=t=>{if(t===this._user.id())return;const s=this._others.findIndex(n=>n.id()===t);s<0||(this._others.splice(s,1),this._emitter.emit("changed",this.users()),this._emitter.emit("disconnected",t))},this._connectionList=e.connectionList,this._model=new k({channel:e.channel,context:e.context}),this._model.register(e.type,"user"),this._model.addPlugin(new q(e.connectionList)),this._model.addPlugin(new U),this._user=this._model.instantiate(e.type,e.context.userId),e.connectionList.emitter().on("connected",this._onConnected),e.connectionList.emitter().on("disconnected",this._onDisconnected),this._model.emitter().on("created",t=>this._onUserCreated(t));for(const t of this._connectionList.users())this._onConnected(t)}user(){return this._user}users(){return[this._user,...this._others]}others(){return[...this._others]}emitter(){return this._emitter}model(){return this._model}send(){this._model.send()}register(e){const t={};for(const i of[this._user,...this._others])t[i.id()]=i.register(e);function s(i){t[i.id()]=i.register(e)}function n(i){const h=t[i];h&&(h(),delete t[i])}return this.emitter().on("connected",s),this.emitter().on("disconnected",n),()=>{this.emitter().off("connected",s),this.emitter().off("disconnected",n);for(const i of Object.values(t))i()}}}class p{constructor(e,t){this._users=new Set,this._emitter=new f,this._onMessage=s=>{switch(s.data.type){case"connected":{if(this._isOwner||this._users.has(s.data.userId))return;this._connected(s.data.userId);break}case"disconnected":{if(this._isOwner||!this._users.has(s.data.userId))return;this._disconnected(s.data.userId);break}case"sync":{if(this._isOwner)return;this._sync(s.data.userIds)}}},this._isOwner=e,this._channel=t,this._channel.addListener(this._onMessage)}static owner(e){return new p(!0,e)}static client(e){return new p(!1,e)}emitter(){return this._emitter}users(){return this._users.values()}isConnected(e){return this._users.has(e)}connected(e){this._users.has(e)||(this._connected(e),this._isOwner&&(this._channel.post(c.Address.broadcast(),{type:"connected",userId:e}),this._channel.post(c.Address.to(e),{type:"sync",userIds:[...this._users]})))}disconnected(e){this._users.has(e)&&(this._disconnected(e),this._isOwner&&this._channel.post(c.Address.broadcast(),{type:"disconnected",userId:e}))}_connected(e){this._users.add(e),this._emitter.emit("connected",e)}_disconnected(e){this._users.delete(e),this._emitter.emit("disconnected",e)}_sync(e){for(const t of[...this._users])e.includes(t)||this._disconnected(t);for(const t of e)this._users.has(t)||this._connected(t);this._emitter.emit("sync")}}class u{constructor(e,t){this._callHandler=null,this._callback=t,this.address=e}static setCallHandler(e,t){e._callHandler=t}static host(e){return new u(c.Address.host(),e)}static target(e,t){return new u(c.Address.to(e),t)}static broadcast(e){return new u(c.Address.broadcast(),e)}static all(e){return new u(c.Address.all(),e)}static dynamic(e,t){return new u(c.Address.dynamic(e),t)}static call(e,t){try{e._callback(...t)}catch(s){console.error("Error while executing RPC:",s)}}call(...e){if(this._callHandler===null)throw new Error("Trying to call RPC without initialization");return this._callHandler.call(this.address,e)}}var S;(r=>{function e(t,s){return{id:t,args:s}}r.make=e})(S||(S={}));class G{constructor(e,t){this._rpcs={},this._onMessage=s=>{const n=s.data,i=s.originId;c.Address.match(s.originId,s.address,this._self)&&this._onRequest(n,i)},this._self=e,this._channel=t,this._channel.addListener(this._onMessage)}register(e,t){if(console.log(this._self.id(),"registering rpc",t),this._rpcs[t]){console.error("Trying to register rpc twice:",t);return}this._rpcs[t]=e,u.setCallHandler(e,this._makeCallHandler(t))}infuse(e,t){for(const s in e)e[s]instanceof u&&this.register(e[s],`${t}.${s}`)}_makeCallHandler(e){return{call:(s,n)=>{const i=S.make(e,n);this._channel.post(s,i)}}}_onRequest(e,t){const{id:s,args:n}=e,i=this._rpcs[s];if(!i){console.error(`Received unhandled RPC request '${s}', originated from ${t}`);return}u.call(i,n)}}class X{constructor(e){this._handler=e}beforeCreate(e){let t=0;for(const s in e){const n=e[s];n instanceof u&&this._handler.register(n,`${e.id()}.${t++}`)}}}const Y={frequency:100,tolerance:3};class Z{constructor(e){this._interval=null,this._uselessTicks=0,this._needsSend=()=>{this._interval===null&&(this._interval=setInterval(this._send,this._options.frequency,void 0))},this._send=()=>{if(!this._modelHandle.changeQueue().needsSend()){this._uselessTicks++,this._uselessTicks>=this._options.tolerance&&(clearInterval(this._interval),this._interval=null,this._uselessTicks=0);return}this._modelHandle.send()},this._options={...Y,...e}}init(e){this._modelHandle=e,e.changeQueue().emitter().on("needsSend",this._needsSend),e.changeQueue().needsSend()&&this._needsSend()}}function K(r){return function(e,t){const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(i){this[s].set(i)}}),Object.defineProperty(e,s,{get(){let i=this[n];return i||(i=new R(r),this[n]=i),i},enumerable:!0})}}function x(r){return function(e,t){const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()}}),Object.defineProperty(e,s,{get(){let i=this[n];return i||(i=new H(r),this[n]=i),i},enumerable:!0})}}function ee(r){return function(e,t){const s="$"+t,n=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(i){this[s].set(i)}}),Object.defineProperty(e,s,{get(){let i=this[n];return i||(i=new A(r),this[n]=i),i},enumerable:!0})}}const te={any:K,syncObject:x,syncObjectRef:ee};function w(r){return function(e,t,s){const n="$"+t,i=Symbol(t),h=s.value;s.value=function(...o){this[n].call(...o)},Object.defineProperty(e,n,{get(){let o=this[i];return o||(o=new u(r(this),h.bind(this)),o.call=o.call.bind(o),this[i]=o),o},enumerable:!0})}}function se(){return w(c.Address.host)}function ne(){return w(c.Address.all)}function ie(){return w(c.Address.broadcast)}function re(){return w(r=>c.Address.to(r.id()))}function ce(r){return w(()=>c.Address.dynamic(r))}const he={host:se,all:ne,broadcast:ie,owner:re,dynamic:ce};c.AnyField=R,c.ArrayField=V,c.ConnectionList=p,c.ConnectionPlugin=q,c.Context=C,c.Emitter=f,c.Field=d,c.Model=k,c.Presence=W,c.RPC=u,c.RPCHandler=G,c.RPCPlugin=X,c.Router=M,c.SendLoopPlugin=Z,c.SyncObject=g,c.SyncObjectField=H,c.SyncObjectRefField=A,c.SyncObjectRefSetField=B,c.field=te,c.rpc=he,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
