(function(o,i){typeof exports=="object"&&typeof module<"u"?i(exports):typeof define=="function"&&define.amd?define(["exports"],i):(o=typeof globalThis<"u"?globalThis:o||self,i(o.dist={}))})(this,function(o){"use strict";var b=Object.defineProperty;var v=(o,i,u)=>i in o?b(o,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):o[i]=u;var d=(o,i,u)=>(v(o,typeof i!="symbol"?i+"":i,u),u);var i=Object.defineProperty,u=(r,e,t)=>e in r?i(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,l=(r,e,t)=>(u(r,typeof e!="symbol"?e+"":e,t),t);class _{constructor(){l(this,"_listeners",{}),l(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}var a;(r=>{const e={type:0};function t(){return e}r.broadcast=t;function s(c){return{type:1,id:c}}r.to=s;function n(c,g){return c.type===0||g.type===0?!0:c.id===g.id}r.match=n;function h(c){switch(c.type){case 0:return"*";case 1:return`:${c.id}`;default:return"?"}}r.toString=h;function f(c){return c==="*"?t():c.startsWith(":")?s(c.slice(1)):null}r.parse=f})(a||(a={}));var m;(r=>{function e(n,h,f){return{type:0,id:n,name:h,data:f}}r.request=e;function t(n,h){return{type:1,id:n,data:h}}r.response=t;function s(n,h){return{type:2,id:n,reason:h}}r.error=s})(m||(m={}));var p;(r=>{function e(t){return{emitter(){return t.emitter},get:t.get,requestObject(s,n){return t.objectsEmitter.on(s,n),n(t.get(s)),{destroy(){t.objectsEmitter.off(s,n)}}}}}r.make=e})(p||(p={}));var y;(r=>{function e(t,s){return{type:t,create:n=>new s(n,t)}}r.create=e})(y||(y={}));class O{constructor(e,t){d(this,"_id");d(this,"_address");d(this,"_emitter",new _);d(this,"_socketIOEmitter",new _);d(this,"_socket");d(this,"_onMessage",(e,t)=>{if(console.log("recv message",e,t),typeof e=="number"&&typeof t=="string")try{const s=JSON.parse(t);if(!s)return;this._emitter.emit("message",{channel:e,message:s})}catch(s){console.error(`Error receiving network message (${this._id})`,s)}});this._id=e,this._address=a.to(e),this._socket=t,t.on("message",this._onMessage),t.on("disconnect",()=>{this.destroy(),this._socketIOEmitter.emit("disconnect")})}id(){return this._id}address(){return this._address}emitter(){return this._emitter}socketIOEmitter(){return this._socketIOEmitter}send(e,t){this._socket.send(e,JSON.stringify(t))}destroy(){this._socket.removeAllListeners()}}class k{constructor(){d(this,"_peers",new Map);d(this,"_emitter",new _)}addSocket(e){const t=e.handshake.query.peerId;if(this._peers.has(t))return;const s=new O(t,e);s.socketIOEmitter().on("disconnect",()=>{this._peers.get(t)===s&&this._peers.delete(t)}),s.emitter().on("message",n=>{this._emitter.emit("message",{peerId:t,...n})}),this._peers.set(t,s)}id(){return"HOST"}peers(){return this._peers.values()}emitter(){return this._emitter}}o.SocketIONetwork=k,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
