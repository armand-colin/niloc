(function(d,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(d=typeof globalThis<"u"?globalThis:d||self,c(d.dist={}))})(this,function(d){"use strict";var W=Object.defineProperty;var B=(d,c,f)=>c in d?W(d,c,{enumerable:!0,configurable:!0,writable:!0,value:f}):d[c]=f;var g=(d,c,f)=>(B(d,typeof c!="symbol"?c+"":c,f),f);var c=Object.defineProperty,f=(i,e,t)=>e in i?c(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,h=(i,e,t)=>(f(i,typeof e!="symbol"?e+"":e,t),t),w;(i=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function n(){return e}i.all=n;function r(){return t}i.broadcast=r;function o(){return s}i.host=o;function l(a){return{type:2,id:a}}i.to=l;function _(a){return{type:4,get:a}}i.dynamic=_;function A(a,p,m){return m.address().type===1||m.address().type===0||p.type===0?!0:p.type===1?m.id()!==a:p.type===3?m.address().type===3:(p.type===4?p.get():p.id)===m.id()}i.match=A;function P(a){switch(a.type){case 0:return"*";case 1:return"#";case 2:return`:${a.id}`;case 4:return`:${a.get()}`;case 3:return"host";default:return"?"}}i.toString=P;function F(a){return a==="*"?n():a==="#"?r():a==="host"?o():a.startsWith(":")?l(a.slice(1)):null}i.parse=F})(w||(w={}));var C=Object.defineProperty,R=(i,e,t)=>e in i?C(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,v=(i,e,t)=>(R(i,typeof e!="symbol"?e+"":e,t),t);class b{constructor(){v(this,"_listeners",{}),v(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}var y;(i=>{function e(t,s){const n=[],r=new b;t.addListener(o=>{const[l,_]=o.data;r.emit(l.toString(),{...o,data:_})});for(let o=0;o<s;o++)n.push({post:(l,_)=>{t.post(l,[o,_])},addListener:l=>{r.on(o.toString(),l)},removeListener:l=>{r.off(o.toString(),l)}});return n}i.split=e})(y||(y={}));var I;(i=>{function e(){return(n,r)=>r.host}i.host=e;function t(){return(n,r)=>n.id()===r.userId}i.own=t;function s(n,r,o){return n===!0||n(r,o)}i.allows=s})(I||(I={}));class S{constructor(){h(this,"_string","")}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class O{constructor(){h(this,"_indent",0),h(this,"_string",""),h(this,"_line",new S)}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new S}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class u{constructor(){h(this,"_index",-1),h(this,"_changeRequester",null),h(this,"_emitter",new b)}static setIndex(e,t){e._index=t}static setChangeRequester(e,t){e._changeRequester=t,e.onChangeRequester(t)}static setModelHandle(e,t){e.onModelHandle(t)}static toString(e){const t=new O;return this.write(e,t),t.toString()}static write(e,t){e.toString(t)}static register(e,t){const s=[...e];for(const n of s)n.emitter().on("changed",t);return()=>{for(const n of s)n.emitter().off("changed",t)}}index(){return this._index}emitter(){return this._emitter}readChange(e){this.read(e)}writeChange(e){this.write(e)}clearChange(){}changed(){var e;(e=this._changeRequester)==null||e.change(this._index),this._emitter.emit("changed")}onChangeRequester(e){}onModelHandle(e){}toString(e){e.writeLine("???")}}class j{constructor(e,t){h(this,"_id"),h(this,"_type"),h(this,"_fields",null),h(this,"_changeRequester"),this._id=e,this._type=t}static __setChangeRequester(e,t){e._changeRequester=t;for(const s of e.fields())u.setChangeRequester(s,t)}static __setModelHandle(e,t){for(const s of e.fields())u.setModelHandle(s,t)}static toString(e){const t=new O;return this.write(e,t),t.toString()}static write(e,t){t.writeLine(`${e.type()}: ${e.id()} {`),t.startIndent();for(const s of e.fields())u.write(s,t);t.endIndent(),t.writeLine("}")}id(){return this._id}type(){return this._type}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())t.read(e)}write(e){for(const t of this.fields())t.write(e)}send(){this._changeRequester.send()}register(e){return u.register(this.fields(),e)}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof u&&(u.setIndex(s,e.length),e.push(s))}return e}}var k;(i=>{function e(t){return{emitter(){return t.emitter},context(){return t.context},syncTo:t.syncTo,get:t.get,requestObject(s,n){return t.objectsEmitter.on(s,n),n(t.get(s)),{destroy(){t.objectsEmitter.off(s,n)}}}}}i.make=e})(k||(k={}));var L;(i=>{function e(t,s,n){return{type:t,create:r=>new s(r,t),authority:n??!0}}i.create=e})(L||(L={}));class H extends u{constructor(e){super(),h(this,"_value"),this._value=e}get(){return this._value}set(e){this._value=e,this.changed()}read(e){this._value=e.readJSON(),this.emitter().emit("changed")}write(e){e.writeJSON(this._value)}toString(e){switch(typeof this._value){case"function":e.writeLine("[Function]");break;case"object":e.write(JSON.stringify(this._value));break;default:e.writeLine(""+this._value);break}}}class N{constructor(){h(this,"_changes",[])}get last(){return this._changes[this._changes.length-1]}*_reverse(){for(let e=this._changes.length-1;e>-1;e--)yield this._changes[e]}push(...e){const t=this.last;if(t&&t.type===0){t.values.push(...e);return}this._changes.push({type:0,values:e})}pop(){const e=this.last;if(e){if(e.type===0){this._changes.pop();return}if(e.type===1){e.n++;return}}this._changes.push({type:1,n:1})}set(e,t){for(const s of this._reverse()){if(s.type!==2)break;if(s.index===e){s.value=t;return}}this._changes.push({type:2,index:e,value:t})}clear(){this._changes=[],this._changes.push({type:3})}write(e){e.writeInt(this._changes.length);for(const t of this._changes)switch(e.writeInt(t.type),t.type){case 0:e.writeInt(t.values.length);for(const s of t.values)e.writeJSON(s);break;case 1:e.writeInt(t.n);break;case 2:e.writeInt(t.index),e.writeJSON(t.value);break}}read(e,t){const s=e.readInt();for(let n=0;n<s;n++)switch(e.readInt()){case 0:const r=e.readInt();for(let _=0;_<r;_++)t.push(e.readJSON());break;case 1:const o=e.readInt();for(let _=0;_<o;_++)t.pop();break;case 2:const l=e.readInt();t[l]=e.readJSON();break;case 3:t.splice(0,t.length);break}}reset(){this._changes=[]}}class M extends u{constructor(e){super(),h(this,"_value"),h(this,"_changes",new N),this._value=e}get(){return this._value}push(...e){this._value.push(...e),this._changes.push(...e),this.changed()}pop(){const e=this._value.pop();return e&&(this._changes.pop(),this.changed()),e??null}set(e){this._value=e,this._changes.clear(),this._changes.push(...e),this.changed()}setAt(e,t){if(e<0||e>=this._value.length)throw new Error("Index out of range");this._value[e]=t,this._changes.set(e,t),this.changed()}clear(){this._value.length!==0&&(this._value=[],this._changes.clear(),this.changed())}read(e){this._value=e.readJSON(),this.emitter().emit("changed")}write(e){e.writeJSON(this._value)}readChange(e){this._changes.read(e,this._value),this.changed()}writeChange(e){this._changes.write(e)}clearChange(){this._changes.reset()}}class J extends u{constructor(e,t){super(),h(this,"_object"),h(this,"_changes",[]),this._object=e.create(t??"sub")}get(){return this._object}read(e){this._object.read(e),this.emitter().emit("changed")}write(e){this._object.write(e)}readChange(e){const t=e.readInt();for(let s=0;s<t;s++){const n=e.readInt();this._object.fields()[n].readChange(e)}this.emitter().emit("changed")}writeChange(e){const t=this._changes.length;e.writeInt(t);for(const s of this._changes)e.writeInt(s),this._object.fields()[s].writeChange(e)}clearChange(){for(const e of this._changes)this._object.fields()[e].clearChange();this._changes=[]}onModelHandle(e){j.__setModelHandle(this._object,e)}onChangeRequester(e){j.__setChangeRequester(this._object,{change:t=>{this._changes.push(t),e.change(this.index()),this.emitter().emit("changed")},send:()=>{e.send()}})}toString(e){j.write(this._object,e)}}class E extends u{constructor(e){super(),h(this,"_objectId"),h(this,"_object",null),h(this,"_modelHandle",null),h(this,"_objectRequest",null),this._objectId=e}read(e){const t=e.readJSON();t!==this._objectId&&(this._setObjectId(t),this.emitter().emit("changed"))}write(e){e.writeJSON(this._objectId)}set(e){const t=(e==null?void 0:e.id())??null;t!==this._objectId&&(this._setObjectId(t),this.changed())}get(){return this._object}_setObjectId(e){var t,s;(t=this._objectRequest)==null||t.destroy(),this._objectId=e,this._object=null,e?this._objectRequest=((s=this._modelHandle)==null?void 0:s.requestObject(e,n=>{this._object=n}))??null:this._objectRequest=null,this.emitter().emit("changed")}onModelHandle(e){this._modelHandle=e,this._objectId&&this._setObjectId(this._objectId)}toString(e){e.write("ref "),this._object?j.write(this._object,e):e.writeLine(`${this._objectId} (null)`)}}class z extends u{constructor(){super(...arguments),h(this,"_objects",new Map),h(this,"_modelHandle",null)}add(e){this._objects.set(e.id(),e),this.changed()}remove(e){this._objects.delete(e.id()),this.changed()}has(e){return this._objects.has(e.id())}*values(){for(const e of this._objects.values())e!==null&&(yield e)}read(e){var t;const s=e.readInt();this._objects.clear();for(let n=0;n<s;n++){const r=e.readString();this._objects.set(r,((t=this._modelHandle)==null?void 0:t.get(r))??null)}this.emitter().emit("changed")}write(e){e.writeInt(this._objects.size);for(const t of this._objects.keys())e.writeString(t)}onModelHandle(e){this._modelHandle=e,this._modelHandle.emitter().on("created",t=>{const s=t.id();this._objects.has(s)&&this._objects.set(s,t),this.emitter().emit("changed")})}}var x;(i=>{function e(o){return new H(o)}i.any=e;function t(o){return new M(o)}i.array=t;function s(o){return new E(o)}i.ref=s;function n(o){return new J(o)}i.object=n;function r(){return new z}i.refSet=r})(x||(x={}));var q;(i=>{function e(t,s){return{id:t,args:s}}i.make=e})(q||(q={}));class T{constructor(e,t,s){g(this,"_id");g(this,"_address");g(this,"_emitter",new b);g(this,"_socketIOEmitter",new b);g(this,"_socket");g(this,"_onMessage",(e,t)=>{if(typeof e=="number"&&typeof t=="string")try{const s=JSON.parse(t);if(!s)return;this._emitter.emit("message",{channel:e,message:s})}catch(s){console.error(`Error receiving network message (${this._id})`,s)}});this._id=t,this._address=s?w.host():w.to(t),this._socket=e,e.on("message",this._onMessage),e.on("disconnect",()=>{this.destroy(),this._socketIOEmitter.emit("disconnect")})}id(){return this._id}address(){return this._address}emitter(){return this._emitter}socketIOEmitter(){return this._socketIOEmitter}send(e,t){this._socket.send(e,JSON.stringify(t))}destroy(){this._socket.removeAllListeners()}}class ${constructor(){g(this,"_peers",new Map);g(this,"_emitter",new b)}peers(){return this._peers.values()}emitter(){return this._emitter}addSocket(e,t,s){if(this._peers.has(t))return;const n=new T(e,t,s);n.socketIOEmitter().on("disconnect",()=>{this._peers.get(t)===n&&this._peers.delete(t)}),n.emitter().on("message",r=>{this._emitter.emit("message",{peerId:t,...r})}),this._peers.set(t,n)}}d.SocketIONetwork=$,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
