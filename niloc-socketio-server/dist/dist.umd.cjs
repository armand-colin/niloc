(function(d,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(d=typeof globalThis<"u"?globalThis:d||self,h(d.dist={}))})(this,function(d){"use strict";var B=Object.defineProperty;var E=(d,h,u)=>h in d?B(d,h,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[h]=u;var w=(d,h,u)=>(E(d,typeof h!="symbol"?h+"":h,u),u);var h;(i=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function r(){return e}i.all=r;function n(){return t}i.broadcast=n;function c(){return s}i.host=c;function l(o){return{type:2,id:o}}i.to=l;function _(o){return{type:4,get:o}}i.dynamic=_;function F(o){return o.host?c():l(o.userId)}i.fromIdentity=F;function J(o,f,m){return f.type===0?!0:f.type===1?m.userId!==o:f.type===3?m.host:(f.type===4?f.get():f.id)===m.userId}i.match=J;function C(o){switch(o.type){case 0:return"*";case 1:return"#";case 2:return`:${o.id}`;case 4:return`:${o.get()}`;case 3:return"host";default:return"?"}}i.toString=C;function T(o){return o==="*"?r():o==="#"?n():o==="host"?c():o.startsWith(":")?l(o.slice(1)):null}i.parse=T})(h||(h={}));var u=Object.defineProperty,I=(i,e,t)=>e in i?u(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e,t)=>(I(i,typeof e!="symbol"?e+"":e,t),t);class g{constructor(){S(this,"_listeners",{}),S(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}class O extends g{send(e,t,s){for(const r of this.peers())r.identity.userId!==s&&r.match(t.address,s)&&r.send(e,t)}connect(e){e.on("message",({channel:t,message:s})=>{this.emit("message",{peerId:e.identity.userId,channel:t,message:s})})}}class D extends g{constructor(e){super(),this.identity=e,this._closed=!1}get closed(){return this._closed}match(e,t){return h.match(t,e,this.identity)}destroy(){this._closed||(this._closed=!0,this.emit("destroy",this),this.removeAllListeners())}}var v;(i=>{function e(t,s){const r=[],n=new g;t.addListener(c=>{const[l,_]=c.data;n.emit(l.toString(),{...c,data:_})});for(let c=0;c<s;c++)r.push({post:(l,_)=>{t.post(l,[c,_])},addListener:l=>{n.on(c.toString(),l)},removeListener:l=>{n.off(c.toString(),l)}});return r}i.split=e})(v||(v={}));class y{static deserialize(e){return new y(e.userId,e.host)}constructor(e,t=!1){this.host=t,this.userId=e}serialize(){return{userId:this.userId,host:this.host}}}var p=(i=>(i[i.All=0]="All",i[i.Host=1]="Host",i[i.Owner=2]="Owner",i))(p||{});(i=>{function e(t,s){switch(t.authority){case 0:return!0;case 1:return s.host;case 2:return s.userId===t.id}return!1}i.allows=e})(p||(p={}));class L{constructor(){this._string=""}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class b{constructor(){this._indent=0,this._string="",this._line=new L}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new L}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class a extends g{constructor(){super(...arguments),this._index=-1,this.dirty=!1}static setIndex(e,t){e._index=t}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model,e.onInit()}static toString(e){const t=new b;return this.writeString(e,t),t.toString()}static isDirty(e){return e.dirty}static writeString(e,t){e.toString(t)}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static writeDelta(e,t){e.writeDelta(t)}static readDelta(e,t){e.readDelta(t)}static resetDelta(e){e.resetDelta(),e.dirty=!1}static register(e,t){const s=[...e];for(const r of s)r.on("change",t);return()=>{for(const r of s)r.off("change",t)}}get index(){return this._index}readDelta(e){this.read(e)}writeDelta(e){this.write(e)}resetDelta(){}changed(){var e;this.dirty=!0,(e=this.changeRequester)==null||e.change(this._index),this.emit("change",this.get())}onInit(){}toString(e){e.writeLine("???")}}class $ extends a{constructor(e){super(),this.value=e}get(){return this.value}set(e){this.equals(this.value,e)||(this.value=e,this.changed())}read(e){this.readValue(e),this.emit("change",this.get())}write(e){e.writeJSON(this.value)}equals(e,t){return e===t}toString(e){switch(typeof this.value){case"function":e.writeLine("[Function]");break;case"object":e.write(JSON.stringify(this.value));break;default:e.writeLine(""+this.value);break}}}class k extends ${readValue(e){this.value=e.readBoolean()}writeValue(e){e.writeBoolean(this.value)}}function j(i){return function(e,t){const s="$"+t,r=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(n){this[s].set(n)}}),Object.defineProperty(e,s,{get(){let n=this[r];return n||(n=i(),this[r]=n),n},enumerable:!0})}}function M(i=!1){return j(()=>new k(i))}var q=Object.defineProperty,A=Object.getOwnPropertyDescriptor,z=(i,e,t,s)=>{for(var r=s>1?void 0:s?A(e,t):e,n=i.length-1,c;n>=0;n--)(c=i[n])&&(r=(s?c(e,t,r):c(r))||r);return s&&r&&q(e,t,r),r};class N extends g{constructor(e){super(),this.authority=p.All,this._fields=null,this._registerMap=new Map,this._onDeletedChange=()=>{this.deleted&&(this.emit("delete"),this.onDelete(),this.changeRequester.delete(),this.removeAllListeners())},this.id=e,this.register("deleted",this._onDeletedChange)}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model;for(const s of e.fields())a.__init(s,t);e.onInit()}static toString(e){const t=new b;return this.writeString(e,t),t.toString()}static writeString(e,t){t.writeLine(`${e.constructor.name}: ${e.id} {`),t.startIndent();for(const s of e.fields())a.writeString(s,t);t.endIndent(),t.writeLine("}")}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static isDirty(e){for(const t of e.fields())if(a.isDirty(t))return!0;return!1}static getDirtyFields(e){const t=[];for(const s of e.fields())a.isDirty(s)&&t.push(s);return t}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())a.read(t,e)}write(e){for(const t of this.fields())a.write(t,e)}send(){this.changeRequester.send()}registerAll(e){if(this._registerMap.has(e))return;const t=a.register(this.fields(),e);this._registerMap.set(e,t)}unregisterAll(e){this._registerMap.has(e)&&(this._registerMap.get(e)(),this._registerMap.delete(e))}register(e,t){const s=this[e];if(s&&s instanceof a){s.on("change",t);return}const r=`$${e}`,n=this[r];if(n&&n instanceof a){n.on("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}unregister(e,t){const s=this[e];if(s&&s instanceof a){s.off("change",t);return}const r=`$${e}`,n=this[r];if(n&&n instanceof a){n.off("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}delete(){this.deleted||(this.deleted=!0)}onInit(){}onDelete(){}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof a&&(a.setIndex(s,e.length),e.push(s))}return e}}z([M(!1)],N.prototype,"deleted",2);var x;(i=>{function e(t,s){return{id:t,args:s}}i.make=e})(x||(x={}));class P extends D{constructor(t,s){super(t);w(this,"_socket");w(this,"_onMessage",(t,s)=>{if(typeof t=="number"&&typeof s=="string")try{const r=JSON.parse(s);if(!r)return;this.emit("message",{channel:t,message:r})}catch(r){console.error(`Error receiving network message (${this.identity.userId})`,r)}});this._socket=s,s.on("message",this._onMessage),s.on("disconnect",()=>this.destroy())}send(t,s){this._socket.send(t,JSON.stringify(s))}destroy(){super.destroy(),this._socket.removeAllListeners()}}class R extends O{constructor(){super(...arguments);w(this,"_peers",new Map)}peers(){return this._peers.values()}addSocket(t,s,r){if(this._peers.has(s))return;const n=new P(new y(s,r),t);n.on("destroy",()=>{this._peers.get(s)===n&&this._peers.delete(s)}),this._peers.set(s,n),this.connect(n)}}d.SocketIONetwork=R,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
