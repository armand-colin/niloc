(function(d,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(d=typeof globalThis<"u"?globalThis:d||self,h(d.dist={}))})(this,function(d){"use strict";var T=Object.defineProperty;var V=(d,h,u)=>h in d?T(d,h,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[h]=u;var w=(d,h,u)=>(V(d,typeof h!="symbol"?h+"":h,u),u);var h;(r=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function i(){return e}r.all=i;function n(){return t}r.broadcast=n;function c(){return s}r.host=c;function l(o){return{type:2,id:o}}r.to=l;function _(o){return{type:4,get:o}}r.dynamic=_;function F(o){return o.host?c():l(o.userId)}r.fromIdentity=F;function E(o,f,m){return f.type===0?!0:f.type===1?m.userId!==o:f.type===3?m.host:(f.type===4?f.get():f.id)===m.userId}r.match=E;function J(o){switch(o.type){case 0:return"*";case 1:return"#";case 2:return`:${o.id}`;case 4:return`:${o.get()}`;case 3:return"host";default:return"?"}}r.toString=J;function C(o){return o==="*"?i():o==="#"?n():o==="host"?c():o.startsWith(":")?l(o.slice(1)):null}r.parse=C})(h||(h={}));var u=Object.defineProperty,x=(r,e,t)=>e in r?u(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,v=(r,e,t)=>(x(r,typeof e!="symbol"?e+"":e,t),t);class g{constructor(){v(this,"_listeners",{}),v(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}class O extends g{send(e,t,s){for(const i of this.peers())i.identity.userId!==s&&i.match(t.address,s)&&i.send(e,t)}connect(e){e.on("message",({channel:t,message:s})=>{this.emit("message",{peerId:e.identity.userId,channel:t,message:s})})}}class D extends g{constructor(e){super(),this.identity=e,this._closed=!1}get closed(){return this._closed}match(e,t){return h.match(t,e,this.identity)}destroy(){this._closed||(this._closed=!0,this.emit("destroy",this),this.removeAllListeners())}}var S;(r=>{function e(t,s){const i=[],n=new g;t.addListener(c=>{const[l,_]=c.data;n.emit(l.toString(),{...c,data:_})});for(let c=0;c<s;c++)i.push({post:(l,_)=>{t.post(l,[c,_])},addListener:l=>{n.on(c.toString(),l)},removeListener:l=>{n.off(c.toString(),l)}});return i}r.split=e})(S||(S={}));class y{static deserialize(e){return new y(e.userId,e.host)}constructor(e,t=!1){this.host=t,this.userId=e}serialize(){return{userId:this.userId,host:this.host}}}var p=(r=>(r[r.All=0]="All",r[r.Host=1]="Host",r[r.Owner=2]="Owner",r))(p||{});(r=>{function e(t,s){switch(t.authority){case 0:return!0;case 1:return s.host;case 2:return s.userId===t.id}return!1}r.allows=e})(p||(p={}));class L{constructor(){this._string=""}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class b{constructor(){this._indent=0,this._string="",this._line=new L}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new L}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class a extends g{constructor(){super(...arguments),this._index=-1,this.dirty=!1}static setIndex(e,t){e._index=t}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model,e.onInit()}static toString(e){const t=new b;return this.writeString(e,t),t.toString()}static isDirty(e){return e.dirty}static writeString(e,t){e.toString(t)}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static writeDelta(e,t){e.writeDelta(t)}static readDelta(e,t){e.readDelta(t)}static resetDelta(e){e.resetDelta(),e.dirty=!1}static register(e,t){const s=[...e];for(const i of s)i.on("change",t);return()=>{for(const i of s)i.off("change",t)}}get index(){return this._index}readDelta(e){this.read(e)}writeDelta(e){this.write(e)}resetDelta(){}changed(){var e;this.dirty=!0,(e=this.changeRequester)==null||e.change(this._index),this.emit("change",this.get())}onInit(){}toString(e){e.writeLine("???")}}class k extends a{constructor(e){super(),this.value=e}get(){return this.value}set(e){this.equals(this.value,e)||(this.value=e,this.changed())}read(e){this.readValue(e),this.emit("change",this.get())}write(e){e.writeJSON(this.value)}equals(e,t){return e===t}toString(e){switch(typeof this.value){case"function":e.writeLine("[Function]");break;case"object":e.write(JSON.stringify(this.value));break;default:e.writeLine(""+this.value);break}}}class $ extends k{readValue(e){this.value=e.readBoolean()}writeValue(e){e.writeBoolean(this.value)}}function j(r){return function(e,t){const s="$"+t,i=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(n){this[s].set(n)}}),Object.defineProperty(e,s,{get(){let n=this[i];return n||(n=r(),this[i]=n),n},enumerable:!0})}}function P(r=!1){return j(()=>new $(r))}var q=Object.defineProperty,M=Object.getOwnPropertyDescriptor,A=(r,e,t,s)=>{for(var i=s>1?void 0:s?M(e,t):e,n=r.length-1,c;n>=0;n--)(c=r[n])&&(i=(s?c(e,t,i):c(i))||i);return s&&i&&q(e,t,i),i};class R extends g{constructor(e){super(),this.authority=p.All,this._fields=null,this._registerMap=new Map,this._onDeletedChange=()=>{this.deleted&&(this.emit("delete"),this.onDelete(),this.changeRequester.delete(),this.removeAllListeners())},this.id=e,this.register("deleted",this._onDeletedChange)}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model;for(const s of e.fields())a.__init(s,t);e.onInit()}static toString(e){const t=new b;return this.writeString(e,t),t.toString()}static writeString(e,t){t.writeLine(`${e.constructor.name}: ${e.id} {`),t.startIndent();for(const s of e.fields())a.writeString(s,t);t.endIndent(),t.writeLine("}")}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static isDirty(e){for(const t of e.fields())if(a.isDirty(t))return!0;return!1}static getDirtyFields(e){const t=[];for(const s of e.fields())a.isDirty(s)&&t.push(s);return t}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())a.read(t,e)}write(e){for(const t of this.fields())a.write(t,e)}send(){this.changeRequester.send()}registerAll(e){if(this._registerMap.has(e))return;const t=a.register(this.fields(),e);this._registerMap.set(e,t)}unregisterAll(e){this._registerMap.has(e)&&(this._registerMap.get(e)(),this._registerMap.delete(e))}register(e,t){const s=this[e];if(s&&s instanceof a){s.on("change",t);return}const i=`$${e}`,n=this[i];if(n&&n instanceof a){n.on("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}unregister(e,t){const s=this[e];if(s&&s instanceof a){s.off("change",t);return}const i=`$${e}`,n=this[i];if(n&&n instanceof a){n.off("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}delete(){this.deleted||(this.deleted=!0)}onInit(){}onDelete(){}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof a&&(a.setIndex(s,e.length),e.push(s))}return e}}A([P(!1)],R.prototype,"deleted",2);var I;(r=>{function e(t,s){return{id:t,args:s}}r.make=e})(I||(I={}));class z extends D{constructor(t,s){super(t);w(this,"_socket");w(this,"_onMessage",(t,s)=>{if(typeof t=="number"&&typeof s=="string")try{const i=JSON.parse(s);if(typeof i!="object")return;this.emit("message",{channel:t,message:i})}catch(i){console.error("Error while parsing message",i)}});this._socket=s,this._socket.on("message",this._onMessage)}send(t,s){this._socket.send(t,JSON.stringify(s))}match(){return!0}}class N extends O{constructor(t){super();w(this,"_serverPeer");this._serverPeer=new z(new y("SERVER"),t),this.connect(this._serverPeer)}*peers(){yield this._serverPeer}}d.SocketIONetwork=N,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
