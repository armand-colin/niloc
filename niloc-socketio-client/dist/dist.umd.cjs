(function(d,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(d=typeof globalThis<"u"?globalThis:d||self,c(d.dist={}))})(this,function(d){"use strict";var J=Object.defineProperty;var T=(d,c,u)=>c in d?J(d,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):d[c]=u;var g=(d,c,u)=>(T(d,typeof c!="symbol"?c+"":c,u),u);var c;(i=>{const e=Object.freeze({type:0}),t=Object.freeze({type:1}),s=Object.freeze({type:3});function r(){return e}i.all=r;function n(){return t}i.broadcast=n;function a(){return s}i.host=a;function l(o){return{type:2,id:o}}i.to=l;function p(o){return{type:4,get:o}}i.dynamic=p;function F(o){return o.host?a():l(o.userId)}i.fromIdentity=F;function E(o,f,w){return w.address.type===1||w.address.type===0||f.type===0?!0:f.type===1?w.id!==o:f.type===3?w.address.type===3:(f.type===4?f.get():f.id)===w.id}i.match=E;function N(o){switch(o.type){case 0:return"*";case 1:return"#";case 2:return`:${o.id}`;case 4:return`:${o.get()}`;case 3:return"host";default:return"?"}}i.toString=N;function V(o){return o==="*"?r():o==="#"?n():o==="host"?a():o.startsWith(":")?l(o.slice(1)):null}i.parse=V})(c||(c={}));class u{constructor(e,t=c.fromIdentity(e)){this.identity=e,this.address=t}get id(){return this.identity.userId}get host(){return this.identity.host}}var O=Object.defineProperty,x=(i,e,t)=>e in i?O(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,S=(i,e,t)=>(x(i,typeof e!="symbol"?e+"":e,t),t);class _{constructor(){S(this,"_listeners",{}),S(this,"_onceListeners",{})}on(e,t){this._listeners[e]||(this._listeners[e]=new Set),this._listeners[e].add(t)}off(e,t){this._listeners[e]&&(this._listeners[e].delete(t),this._listeners[e].size===0&&delete this._listeners[e])}once(e,t){this._onceListeners[e]||(this._onceListeners[e]=new Set),this._onceListeners[e].add(t)}offOnce(e,t){this._onceListeners[e]&&(this._onceListeners[e].delete(t),this._onceListeners[e].size===0&&delete this._onceListeners[e])}emit(e,t){if(this._listeners[e])for(const s of[...this._listeners[e]])s(t);if(this._onceListeners[e]){for(const s of[...this._onceListeners[e]])s(t);delete this._onceListeners[e]}}removeAllListeners(){this._listeners={},this._onceListeners={}}}var v;(i=>{function e(t,s){const r=[],n=new _;t.addListener(a=>{const[l,p]=a.data;n.emit(l.toString(),{...a,data:p})});for(let a=0;a<s;a++)r.push({post:(l,p)=>{t.post(l,[a,p])},addListener:l=>{n.on(a.toString(),l)},removeListener:l=>{n.off(a.toString(),l)}});return r}i.split=e})(v||(v={}));class m{static deserialize(e){return new m(e.userId,e.host)}constructor(e,t=!1){this.host=t,this.userId=e}serialize(){return{userId:this.userId,host:this.host}}}var y=(i=>(i[i.All=0]="All",i[i.Host=1]="Host",i[i.Owner=2]="Owner",i))(y||{});(i=>{function e(t,s){switch(t.authority){case 0:return!0;case 1:return s.host;case 2:return s.userId===t.id}return!1}i.allows=e})(y||(y={}));class L{constructor(){this._string=""}write(e){this._string+=e}toString(e){return"  ".repeat(e)+this._string}}class I{constructor(){this._indent=0,this._string="",this._line=new L}write(e){this._line.write(e)}writeLine(e){this._line.write(e),this.nextLine()}nextLine(){this._string+=this._line.toString(this._indent)+`
`,this._line=new L}startIndent(){this._indent++}endIndent(){this._indent--}toString(){return this.nextLine(),this._string}}class h extends _{constructor(){super(...arguments),this._index=-1,this.dirty=!1}static setIndex(e,t){e._index=t}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model,e.onInit()}static toString(e){const t=new I;return this.writeString(e,t),t.toString()}static isDirty(e){return e.dirty}static writeString(e,t){e.toString(t)}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static writeDelta(e,t){e.writeDelta(t)}static readDelta(e,t){e.readDelta(t)}static resetDelta(e){e.resetDelta(),e.dirty=!1}static register(e,t){const s=[...e];for(const r of s)r.on("change",t);return()=>{for(const r of s)r.off("change",t)}}get index(){return this._index}readDelta(e){this.read(e)}writeDelta(e){this.write(e)}resetDelta(){}changed(){var e;this.dirty=!0,(e=this.changeRequester)==null||e.change(this._index),this.emit("change",this.get())}onInit(){}toString(e){e.writeLine("???")}}class D extends h{constructor(e){super(),this.value=e}get(){return this.value}set(e){this.equals(this.value,e)||(this.value=e,this.changed())}read(e){this.readValue(e),this.emit("change",this.get())}write(e){e.writeJSON(this.value)}equals(e,t){return e===t}toString(e){switch(typeof this.value){case"function":e.writeLine("[Function]");break;case"object":e.write(JSON.stringify(this.value));break;default:e.writeLine(""+this.value);break}}}class k extends D{readValue(e){this.value=e.readBoolean()}writeValue(e){e.writeBoolean(this.value)}}function j(i){return function(e,t){const s="$"+t,r=Symbol(t);Object.defineProperty(e,t,{get(){return this[s].get()},set(n){this[s].set(n)}}),Object.defineProperty(e,s,{get(){let n=this[r];return n||(n=i(),this[r]=n),n},enumerable:!0})}}function $(i=!1){return j(()=>new k(i))}var P=Object.defineProperty,q=Object.getOwnPropertyDescriptor,M=(i,e,t,s)=>{for(var r=s>1?void 0:s?q(e,t):e,n=i.length-1,a;n>=0;n--)(a=i[n])&&(r=(s?a(e,t,r):a(r))||r);return s&&r&&P(e,t,r),r};class R extends _{constructor(e){super(),this.authority=y.All,this._fields=null,this._registerMap=new Map,this._onDeletedChange=()=>{this.deleted&&(this.emit("delete"),this.onDelete(),this.changeRequester.delete(),this.removeAllListeners())},this.id=e,this.register("deleted",this._onDeletedChange)}static __init(e,t){e.changeRequester=t.changeRequester,e.model=t.model;for(const s of e.fields())h.__init(s,t);e.onInit()}static toString(e){const t=new I;return this.writeString(e,t),t.toString()}static writeString(e,t){t.writeLine(`${e.constructor.name}: ${e.id} {`),t.startIndent();for(const s of e.fields())h.writeString(s,t);t.endIndent(),t.writeLine("}")}static write(e,t){e.write(t)}static read(e,t){e.read(t)}static isDirty(e){for(const t of e.fields())if(h.isDirty(t))return!0;return!1}static getDirtyFields(e){const t=[];for(const s of e.fields())h.isDirty(s)&&t.push(s);return t}fields(){return this._fields||(this._fields=this._initFields()),this._fields}read(e){for(const t of this.fields())h.read(t,e)}write(e){for(const t of this.fields())h.write(t,e)}send(){this.changeRequester.send()}registerAll(e){if(this._registerMap.has(e))return;const t=h.register(this.fields(),e);this._registerMap.set(e,t)}unregisterAll(e){this._registerMap.has(e)&&(this._registerMap.get(e)(),this._registerMap.delete(e))}register(e,t){const s=this[e];if(s&&s instanceof h){s.on("change",t);return}const r=`$${e}`,n=this[r];if(n&&n instanceof h){n.on("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}unregister(e,t){const s=this[e];if(s&&s instanceof h){s.off("change",t);return}const r=`$${e}`,n=this[r];if(n&&n instanceof h){n.off("change",t);return}throw new Error(`Field ${e} does not exist on type ${this.constructor.name}`)}delete(){this.deleted||(this.deleted=!0)}onInit(){}onDelete(){}_initFields(){const e=[];for(const t in this){const s=this[t];s instanceof h&&(h.setIndex(s,e.length),e.push(s))}return e}}M([$(!1)],R.prototype,"deleted",2);var b;(i=>{function e(t,s){return{id:t,args:s}}i.make=e})(b||(b={}));class A extends u{constructor(t,s){super(t,c.broadcast());g(this,"_emitter",new _);g(this,"_socket");g(this,"_onMessage",(t,s)=>{if(typeof t=="number"&&typeof s=="string")try{const r=JSON.parse(s);if(typeof r!="object")return;this._emitter.emit("message",{channel:t,message:r})}catch(r){console.error("Error while parsing message",r)}});this._socket=s,this._socket.on("message",this._onMessage)}send(t,s){this._socket.send(t,JSON.stringify(s))}addListener(t){this._emitter.on("message",t)}removeListener(t){this._emitter.off("message",t)}}class z extends _{constructor(t,s){super();g(this,"_serverPeer");g(this,"_identity");this._identity=t,this._serverPeer=new A(new m("SERVER"),s),this._serverPeer.addListener(({channel:r,message:n})=>{this.emit("message",{peerId:this._serverPeer.id,channel:r,message:n})})}identity(){return this._identity}*peers(){yield this._serverPeer}}d.SocketIONetwork=z,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
